# テスト方法

## 方法1: 開発サーバーで手動テスト（推奨）

### 1. 環境変数の設定

`.env.local`ファイルを作成して、OpenAI APIキーを設定してください：

```bash
OPENAI_API_KEY=your_api_key_here
```

### 2. 依存関係のインストール

```bash
npm install
```

### 3. 開発サーバーの起動

```bash
npm run dev
```

ブラウザで `http://localhost:3000` を開きます。

### 4. STEP4のテスト手順

修正した内容をテストするには、以下の手順で進めてください：

1. **STEP1（資格）**: 資格を入力（例：「看護師」）
2. **STEP2（Can）**: 強みを入力（例：「患者さんとのコミュニケーション」）
3. **STEP3（Will）**: やりたいことを入力（例：「訪問看護に挑戦したい」）
4. **STEP4（Must）**: 譲れない条件を入力して、深堀りを3回以上行う

#### テストケース1: 「残業なし」について話す場合

- STEP4で「残業なし」と入力
- 深堀りが3回目になったとき、「今の話と『職場の雰囲気』を比べたら、どっちの方が譲れない？」という質問が出ることを確認

#### テストケース2: 「職場の雰囲気」について話す場合

- STEP4で「職場の雰囲気が良いところ」と入力
- 深堀りが3回目になったとき、「今の話と『働き方（リモートワークや残業など）』を比べたら、どっちの方が譲れない？」という質問が出ることを確認

#### テストケース3: その他の内容について話す場合

- STEP4で「給与が高いところ」と入力
- 深堀りが3回目になったとき、「今の話と『働き方』を比べたら、どっちの方が譲れない？」という質問が出ることを確認

#### テストケース4: フェイルセーフの動作確認

- STEP4で深堀りを3回以上行う
- 3回目で自動的にSTEP5に遷移し、`must_ids`や`must_text`が正しく生成されることを確認

### 5. ブラウザの開発者ツールで確認

ブラウザの開発者ツール（F12）のコンソールで、以下のログを確認できます：

- `[STEP4] User responded. Counter: X` - カウンターの増加を確認
- `[STEP4 FAILSAFE] Forcing transition to STEP5. Server count: X` - フェイルセーフの動作を確認
- `[HANDLER] Restored qual_ids: [...]` - qual_idsの保護を確認
- `[HANDLER] Step changed: X -> Y` - ステップ遷移を確認

## 方法2: 自動テスト（Jest）

### テストファイルの作成

`tests/api/chat.test.js` を作成して、以下のようなテストを書くことができます：

```javascript
describe('handleStep4', () => {
  it('should generate appropriate comparison question based on user input', () => {
    // テストコード
  });
});
```

### テストの実行

```bash
npm test
```

## トラブルシューティング

### OpenAI APIキーが設定されていない場合

エラーメッセージが表示されます。`.env.local`ファイルに正しいAPIキーを設定してください。

### ポート3000が既に使用されている場合

```bash
PORT=3001 npm run dev
```

別のポートで起動できます。

