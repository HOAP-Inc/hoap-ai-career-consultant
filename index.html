<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HOAP AI ã‚­ãƒ£ãƒªã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆã‚¿ã‚°å³å¯†æ•´åˆãƒ‡ãƒ¢ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .gradient-bg{background:linear-gradient(135deg,#fdf2f8 0%,#faf5ff 50%,#eff6ff 100%)}
    .gradient-text{background:linear-gradient(135deg,#ec4899 0%,#8b5cf6 50%,#3b82f6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .message-enter{animation:slideIn .22s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .btn{cursor:pointer;transition:transform .05s ease}
    .btn:active{transform:scale(.98)}
    .chip{display:inline-flex;align-items:center;border:1px solid rgba(236,72,153,.25);background:#fff;border-radius:9999px;padding:.3rem .65rem;margin:.2rem .3rem .2rem 0}
    .chip-ghost{border:1px dashed rgba(99,102,241,.5);background:rgba(255,255,255,.6)}
    .chips{margin-top:.5rem}
  </style>
</head>
<body class="gradient-bg min-h-screen text-slate-800">
  <!-- Header -->
  <div class="bg-white/90 backdrop-blur-sm border-b border-pink-100 sticky top-0 z-10 shadow-sm">
    <div class="max-w-4xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold gradient-text">HOAP AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</h1>
          <p class="text-slate-600 text-sm">ã‚­ãƒ£ãƒªã‚¢ç›¸è«‡ãƒ»ä¸€æ¬¡ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆã‚¿ã‚°å³å¯†æ•´åˆï¼‰</p>
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-500">Step <span id="current-step">1</span>/6</div>
          <div class="text-xs gradient-text font-medium">
            <span id="step-label">åŸºæœ¬æƒ…å ±</span>
            <span id="number-required" class="block text-red-400 text-xs mt-1">â€»æ±‚è·è€…ç•ªå·å¿…é ˆ</span>
          </div>
        </div>
      </div>
      <div class="mt-3 bg-gradient-to-r from-pink-100 to-blue-100 rounded-full h-1">
        <div id="progress-bar" class="bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 h-1 rounded-full transition-all duration-500" style="width:16.67%"></div>
      </div>
      <!-- é¸å®šæ¸ˆã¿ã®å¯è¦–ã‚¨ãƒªã‚¢ -->
      <div class="mt-4 text-sm">
        <div class="text-slate-500">ç¢ºå®šå†…å®¹ï¼ˆå†…éƒ¨ä¿å­˜ã®è¦ç´„è¡¨ç¤ºãƒ»ã‚¿ã‚°ã¯ä¼šè©±ã«å‡ºã•ãªã„ï¼‰</div>
        <div class="chips" id="chips-area">
          <span id="chip-reason" class="chip chip-ghost hidden">è»¢è·ç†ç”±ï¼šæœªè¨­å®š</span>
          <span id="chip-must" class="chip chip-ghost hidden">Mustï¼š0ä»¶</span>
          <span id="chip-want" class="chip chip-ghost hidden">Wantï¼š0ä»¶</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div class="max-w-4xl mx-auto px-6 py-8 pb-32">
    <div id="messages" class="space-y-6">
      <div class="flex justify-start">
        <div class="flex max-w-xs lg:max-w-2xl items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 shadow-md border-2 border-white flex items-center justify-center">
            <span class="text-xl">ğŸ¤–</span>
          </div>
          <div class="bg-white/90 backdrop-blur-sm text-slate-700 border border-pink-100/50 rounded-2xl px-4 py-3 shadow-sm">
            <div class="text-sm whitespace-pre-wrap leading-relaxed">
              MARK TAG-STRICT<br>
              ã“ã‚“ã«ã¡ã¯ï¼<br>
              æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®é¢è«‡ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚€ã‚ˆã†ã«ã€HOAPã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å°‘ã—ã ã‘è©±ã‚’èã‹ã›ã¦ã­ã€‚<br><br>
              ã¾ãš2ã¤æ•™ãˆã¦ï¼<br>
              â‘ ä»Šã®è·ç¨® â‘¡ä»Šã©ã“ã§åƒã„ã¦ã‚‹ï¼Ÿ
            </div>
          </div>
        </div>
      </div>
      <!-- å€™è£œãƒœãƒƒã‚¯ã‚¹ -->
      <div id="option-box" class="hidden">
        <div class="mt-2 rounded-2xl border border-pink-200 bg-white/90 px-4 py-3 shadow-sm">
          <div class="text-xs text-slate-500 mb-2" id="option-hint">ã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿ</div>
          <div id="option-buttons" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-pink-100/50 shadow-xl">
    <div class="max-w-4xl mx-auto px-6 py-4">
      <div class="flex items-end gap-3">
        <div class="flex-1 relative">
          <textarea id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." class="w-full bg-white border border-pink-200 rounded-xl px-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent resize-none min-h-[52px] max-h-32 shadow-sm"></textarea>
        </div>
        <button id="send-button" class="btn bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 hover:from-pink-600 hover:via-purple-600 hover:to-blue-600 text-white rounded-xl p-3 shadow-lg">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22,2 15,22 11,13 2,9"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ======== ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONåŸ‹ã‚è¾¼ã¿ãƒ»å¤–éƒ¨ç”Ÿæˆç¦æ­¢ï¼‰ ========
    // è»¢è·ç†ç”±_åˆ†é¡ãƒ•ãƒ­ãƒ¼ï¼ˆã‚«ãƒ†ã‚´ãƒª/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰/å†…éƒ¨å€™è£œï¼‰
    const REASON_FLOW = {"è»¢è·ç†ç”±_åˆ†é¡ãƒ•ãƒ­ãƒ¼":[
      {"ã‚«ãƒ†ã‚´ãƒª":"çµŒå–¶ãƒ»çµ„ç¹”ã«é–¢ã™ã‚‹ã“ã¨","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["ç†å¿µ","æ–¹é‡","ä¾¡å€¤è¦³","çµŒå–¶","é‹å–¶","ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ","æ–¹å‘æ€§","ãƒ“ã‚¸ãƒ§ãƒ³","ãƒŸãƒƒã‚·ãƒ§ãƒ³","è€ƒãˆæ–¹","å§¿å‹¢","çµŒå–¶é™£","ãƒˆãƒƒãƒ—","é¢¨é€šã—","æ„è¦‹","ç™ºè¨€","è©•ä¾¡åˆ¶åº¦","è©•ä¾¡","æ˜‡çµ¦","æ˜‡æ ¼","å…¬å¹³","åŸºæº–","æ•™è‚²ä½“åˆ¶","ç ”ä¿®","ãƒãƒ‹ãƒ¥ã‚¢ãƒ«","OJT","ãƒ•ã‚©ãƒ­ãƒ¼","æ•™è‚²","ã‚µãƒãƒ¼ãƒˆ","çµŒå–¶è€…","åŒ»ç™‚è·","ç¾å ´ç†è§£","å£²ä¸Š","æ•°å­—"],"å†…éƒ¨å€™è£œ":["MVVãƒ»çµŒå–¶ç†å¿µã«å…±æ„Ÿã§ãã‚‹è·å ´ã§åƒããŸã„","é¢¨é€šã—ãŒã‚ˆãæ„è¦‹ãŒè¨€ã„ã‚„ã™ã„è·å ´ã§åƒããŸã„","è©•ä¾¡åˆ¶åº¦ãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„","æ•™è‚²ä½“åˆ¶ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„","çµŒå–¶è€…ãŒåŒ»ç™‚è·ã®ã¨ã“ã‚ã§åƒããŸã„","çµŒå–¶è€…ãŒåŒ»ç™‚è·ã§ã¯ãªã„ã¨ã“ã‚ã§åƒããŸã„"]},
      {"ã‚«ãƒ†ã‚´ãƒª":"åƒãä»²é–“ã«é–¢ã™ã‚‹ã“ã¨","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["äººé–“é–¢ä¿‚","è·å ´ã®é›°å›²æ°—","ä¸Šå¸","å…ˆè¼©","åŒåƒš","ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯","ã„ã˜ã‚","ãƒ‘ãƒ¯ãƒãƒ©","ã‚»ã‚¯ãƒãƒ©","é™°å£","æ´¾é–¥","ãŠå±€","ç†ä¸å°½","ç›¸è«‡ã§ããªã„","å­¤ç«‹","ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³","ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«","å°Šæ•¬","æ†§ã‚Œ","è¦‹ç¿’ã„ãŸã„","ä¾¡å€¤è¦³","æ¸©åº¦æ„Ÿ","ã‚„ã‚‹æ°—","ä¿¡é ¼","å“æ ¼","ä¸€è²«æ€§","ç›®æ¨™","æ‰‹æœ¬","è·ç¨®","é€£æº","åŠ©ã‘åˆã„","å£","åˆ†æ–­","å¤æ ª","æ¨©åŠ›","åœ§","æ”¯é…"],"å†…éƒ¨å€™è£œ":["äººé–“é–¢ä¿‚ã®ãƒˆãƒ©ãƒ–ãƒ«ãŒå°‘ãªã„è·å ´ã§åƒããŸã„","åŒã˜ä¾¡å€¤è¦³ã‚’æŒã¤ä»²é–“ã¨åƒããŸã„","å°Šæ•¬ã§ãã‚‹ä¸Šå¸ãƒ»çµŒå–¶è€…ã¨åƒããŸã„","ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ãªã‚‹ä¸Šå¸ã‚„å…ˆè¼©ãŒã»ã—ã„","è·ç¨®é–¢ä¿‚ãªãä¸€ä½“æ„ŸãŒã‚ã‚‹ä»²é–“ã¨åƒããŸã„","ãŠå±€ãŒã„ãªã„è·å ´ã§åƒããŸã„"]},
      {"ã‚«ãƒ†ã‚´ãƒª":"ä»•äº‹å†…å®¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«é–¢ã™ã‚‹ã“ã¨","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—","æˆé•·","æŒ‘æˆ¦","ã‚„ã‚ŠãŒã„","æ¥­å‹™å†…å®¹","å°‚é–€æ€§","ç ”ä¿®","æ•™è‚²","ã‚­ãƒ£ãƒªã‚¢","æ˜‡é€²","æ˜‡æ ¼","è³‡æ ¼å–å¾—","çµŒé¨“","å­¦ã¹ã‚‹","æ–°ã—ã„","å¹…ã‚’åºƒã’ã‚‹","çµŒé¨“","å¼·ã¿","æ´»ã‹ã™","è³‡æ ¼","å¾—æ„","æœªçµŒé¨“","åˆ†é‡","æ‚£è€…","åˆ©ç”¨è€…","è²¢çŒ®","å®Ÿæ„Ÿ","æ›¸é¡","ä»¶æ•°","å½¹ç«‹ã¤","ã‚ã‚ŠãŒã¨ã†","è²¬ä»»","å½¹è·","æ©Ÿä¼š","é“ç­‹","ç™»ç”¨"],"å†…éƒ¨å€™è£œ":["ä»Šã¾ã§ã®çµŒé¨“ã‚„è‡ªåˆ†ã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸã„","æœªçµŒé¨“ã®ä»•äº‹ï¼åˆ†é‡ã«æŒ‘æˆ¦ã—ãŸã„","ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸã„","æ‚£è€…ãƒ»åˆ©ç”¨è€…ã¸ã®è²¢çŒ®å®Ÿæ„Ÿã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ä»•äº‹ã«æºã‚ã‚Œã‚‹","æ˜‡é€²ãƒ»æ˜‡æ ¼ã®æ©Ÿä¼šãŒã‚ã‚‹"]},
      {"ã‚«ãƒ†ã‚´ãƒª":"åŠ´åƒæ¡ä»¶ã«é–¢ã™ã‚‹ã“ã¨","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["æ®‹æ¥­","å¤œå‹¤","ä¼‘æ—¥","æœ‰çµ¦","åƒãæ–¹","æ™‚é–“","ã‚·ãƒ•ãƒˆ","å‹¤å‹™æ™‚é–“","é€£å‹¤","ä¼‘æ†©","ã‚ªãƒ³ã‚³ãƒ¼ãƒ«","å‘¼ã³å‡ºã—","å‰¯æ¥­","å…¼æ¥­","ç¤¾ä¼šä¿é™º","ä¿é™º","å¥ä¿","åšç”Ÿå¹´é‡‘","è¨ºç™‚æ™‚é–“","è‡ªå·±ç ”é‘½","å‹‰å¼·","å­¦ç¿’","ç ”ä¿®æ™‚é–“","ç›´è¡Œç›´å¸°","äº‹å‹™æ‰€","ç«‹ã¡å¯„ã‚Š","æœç¤¼","æ—¥å ±","å®šæ™‚","ã‚µãƒ¼ãƒ“ã‚¹æ®‹æ¥­","ç”³è«‹åˆ¶","äººå“¡é…ç½®","å¸Œæœ›æ—¥","åŠä¼‘","æ™‚é–“æœ‰ä¼‘","æ‰¿èª","å°±æ¥­è¦å‰‡","å…¼æ¥­","è¨±å¯","å¥åº·ä¿é™º","é›‡ç”¨ä¿é™º","åŠ´ç½","æ‰‹ç¶šã","å§‹æ¥­å‰","æº–å‚™","æ¸…æƒ","æ‰“åˆ»"],"å†…éƒ¨å€™è£œ":["ç›´è¡Œç›´å¸°ãŒã§ãã‚‹è·å ´ã§åƒããŸã„","æ®‹æ¥­ã®ãªã„è·å ´ã§åƒããŸã„","å¸Œæœ›é€šã‚Šã«æœ‰çµ¦ãŒå–å¾—ã§ãã‚‹è·å ´ã§åƒããŸã„","å‰¯æ¥­OKãªè·å ´ã§åƒããŸã„","ç¤¾ä¼šä¿é™ºã‚’å®Œå‚™ã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„","è¨ºç™‚æ™‚é–“å†…ã§è‡ªå·±ç ”é‘½ã§ãã‚‹è·å ´ã§åƒããŸã„","å‰æ®‹æ¥­ã®ãªã„è·å ´ã§åƒããŸã„"]},
      {"ã‚«ãƒ†ã‚´ãƒª":"ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«é–¢ã™ã‚‹ã“ã¨","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["å®¶åº­","è‚²å…","å­è‚²ã¦","ä¸¡ç«‹","ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸","å­ã©ã‚‚","å®¶æ—","ä»‹è­·","ä¿è‚²åœ’","é€è¿","å­¦æ ¡è¡Œäº‹","é€šé™¢","ç™ºç†±","ä¸­æŠœã‘","æ™‚çŸ­","ã‚¤ãƒ™ãƒ³ãƒˆ","é£²ã¿ä¼š","BBQ","ç¤¾å“¡æ—…è¡Œ","æ—©æœæ¸…æƒ","å¼·åˆ¶","æ¥­å‹™å¤–","å°±æ¥­å¾Œ","ä¼‘æ—¥","ã‚ªãƒ•","ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ","ä»²è‰¯ã","äº¤æµ","ã”ã¯ã‚“","è¶£å‘³"],"å†…éƒ¨å€™è£œ":["å®¶åº­ã¨ã®ä¸¡ç«‹ã«ç†è§£ã®ã‚ã‚‹è·å ´ã§åƒããŸã„","å‹¤å‹™æ™‚é–“å¤–ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„è·å ´ã§åƒããŸã„","ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§ã‚‚ä»²è‰¯ãã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„"]},
      {"ã‚«ãƒ†ã‚´ãƒª":"è·å ´ç’°å¢ƒãƒ»è¨­å‚™","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["è¨­å‚™","ç’°å¢ƒ","æ–½è¨­","å™¨æ¢°","æ©Ÿå™¨","ã‚·ã‚¹ãƒ†ãƒ ","IT","ãƒ‡ã‚¸ã‚¿ãƒ«","å¤ã„","æ–°ã—ã„","æœ€æ–°","è¨­ç½®","å°å…¥","æ•´å‚™"],"å†…éƒ¨å€™è£œ":[]},
      {"ã‚«ãƒ†ã‚´ãƒª":"è·å ´ã®å®‰å®šæ€§","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["å®‰å®š","å°†æ¥æ€§","çµŒå–¶çŠ¶æ³","å€’ç”£","ãƒªã‚¹ãƒˆãƒ©","ä¸å®‰","ç¶™ç¶š","æŒç¶š","æˆé•·","ç™ºå±•","å°†æ¥","å…ˆè¡Œã"],"å†…éƒ¨å€™è£œ":[]},
      {"ã‚«ãƒ†ã‚´ãƒª":"çµ¦ä¸ãƒ»å¾…é‡","ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰":["çµ¦æ–™","çµ¦ä¸","å¹´å","æœˆå","æ‰‹å–ã‚Š","è³ä¸","ãƒœãƒ¼ãƒŠã‚¹","æ˜‡çµ¦","æ‰‹å½“","å¾…é‡","ç¦åˆ©åšç”Ÿ","å®‰ã„","ä½ã„","ä¸ŠãŒã‚‰ãªã„","ç”Ÿæ´»ã§ããªã„","ãŠé‡‘"],"å†…éƒ¨å€™è£œ":[]}
    ]};

    // è»¢è·ç›®çš„ï¼ˆæ­£å¼ tag_label ã‚¬ãƒ¼ãƒ‰ç”¨ï¼šé…åˆ—åŒ–ï¼‰
    const PURPOSE_TAGS = [
      "MVVãƒ»çµŒå–¶ç†å¿µã«å…±æ„Ÿã§ãã‚‹è·å ´ã§åƒããŸã„",
      "é¢¨é€šã—ãŒã‚ˆãæ„è¦‹ãŒè¨€ã„ã‚„ã™ã„è·å ´ã§åƒããŸã„",
      "è©•ä¾¡åˆ¶åº¦ãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„",
      "æ•™è‚²ä½“åˆ¶ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„",
      "çµŒå–¶è€…ãŒåŒ»ç™‚è·ã®ã¨ã“ã‚ã§åƒããŸã„",
      "çµŒå–¶è€…ãŒåŒ»ç™‚è·ã§ã¯ãªã„ã¨ã“ã‚ã§åƒããŸã„",
      "äººé–“é–¢ä¿‚ã®ãƒˆãƒ©ãƒ–ãƒ«ãŒå°‘ãªã„è·å ´ã§åƒããŸã„",
      "åŒã˜ä¾¡å€¤è¦³ã‚’æŒã¤ä»²é–“ã¨åƒããŸã„",
      "å°Šæ•¬ã§ãã‚‹ä¸Šå¸ãƒ»çµŒå–¶è€…ã¨åƒããŸã„",
      "ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ãªã‚‹ä¸Šå¸ã‚„å…ˆè¼©ãŒã»ã—ã„",
      "è·ç¨®é–¢ä¿‚ãªãä¸€ä½“æ„ŸãŒã‚ã‚‹ä»²é–“ã¨åƒããŸã„",
      "ãŠå±€ãŒã„ãªã„è·å ´ã§åƒããŸã„",
      "ä»Šã¾ã§ã®çµŒé¨“ã‚„è‡ªåˆ†ã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸã„",
      "æœªçµŒé¨“ã®ä»•äº‹ï¼åˆ†é‡ã«æŒ‘æˆ¦ã—ãŸã„",
      "ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸã„",
      "æ‚£è€…ãƒ»åˆ©ç”¨è€…ã¸ã®è²¢çŒ®å®Ÿæ„Ÿã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ä»•äº‹ã«æºã‚ã‚Œã‚‹",
      "æ˜‡é€²ãƒ»æ˜‡æ ¼ã®æ©Ÿä¼šãŒã‚ã‚‹",
      "ç›´è¡Œç›´å¸°ãŒã§ãã‚‹è·å ´ã§åƒããŸã„",
      "æ®‹æ¥­ã®ãªã„è·å ´ã§åƒããŸã„",
      "å¸Œæœ›é€šã‚Šã«æœ‰çµ¦ãŒå–å¾—ã§ãã‚‹è·å ´ã§åƒããŸã„",
      "å‰¯æ¥­OKãªè·å ´ã§åƒããŸã„",
      "ç¤¾ä¼šä¿é™ºã‚’å®Œå‚™ã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„",
      "è¨ºç™‚æ™‚é–“å†…ã§è‡ªå·±ç ”é‘½ã§ãã‚‹è·å ´ã§åƒããŸã„",
      "å‰æ®‹æ¥­ã®ãªã„è·å ´ã§åƒããŸã„",
      "å®¶åº­ã¨ã®ä¸¡ç«‹ã«ç†è§£ã®ã‚ã‚‹è·å ´ã§åƒããŸã„",
      "å‹¤å‹™æ™‚é–“å¤–ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„è·å ´ã§åƒããŸã„",
      "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§ã‚‚ä»²è‰¯ãã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„"
    ];

    // mustwantï¼ˆä¸€æ‹¬è¾æ›¸ï¼‰â†’ Step2/3 ã®å€™è£œé›†åˆ
    const MUSTWANT_DICT = /* æŠœç²‹ã›ãšå…¨é‡ */ {
      "categories": {
        "ã‚µãƒ¼ãƒ“ã‚¹å½¢æ…‹": {
          "åŒ»ç™‚": ["æ€¥æ€§æœŸç—…æ£Ÿ","å›å¾©æœŸç—…æ£Ÿ","æ…¢æ€§æœŸãƒ»ç™‚é¤Šå‹ç—…é™¢","ä¸€èˆ¬ç—…é™¢","åœ°åŸŸåŒ…æ‹¬ã‚±ã‚¢ç—…æ£Ÿ","ç™‚é¤Šç—…æ£Ÿ","ç·©å’Œã‚±ã‚¢ç—…æ£Ÿï¼ˆãƒ›ã‚¹ãƒ”ã‚¹ï¼‰","ã‚¯ãƒªãƒ‹ãƒƒã‚¯","ç²¾ç¥ç§‘ç—…é™¢","è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³","ç²¾ç¥ç§‘ç‰¹åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³","æ©Ÿèƒ½å¼·åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³","è¨ªå•ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³","è¨ªå•æ „é¤ŠæŒ‡å°"],
          "ä»‹è­·": ["é€šæ‰€ä»‹è­·ï¼ˆãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰","èªçŸ¥ç—‡å¯¾å¿œå‹é€šæ‰€ä»‹è­·ï¼ˆèªçŸ¥ç—‡å°‚é–€ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰","åœ°åŸŸå¯†ç€å‹é€šæ‰€ä»‹è­·ï¼ˆå®šå“¡18åä»¥ä¸‹ï¼‰","é€šæ‰€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ã‚¤ã‚±ã‚¢ï¼‰","è¨ªå•ä»‹è­·","å®šæœŸå·¡å›ãƒ»éšæ™‚å¯¾å¿œå‹è¨ªå•ä»‹è­·çœ‹è­·","è¨ªå•å…¥æµ´","å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·","çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·","ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ","åœ°åŸŸå¯†ç€å‹ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ï¼ˆå®šå“¡29åä»¥ä¸‹ï¼‰","ä»‹è­·è€äººä¿å¥æ–½è¨­","ä»‹è­·ä»˜ãæœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ","ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼ˆçŸ­æœŸå…¥æ‰€ç”Ÿæ´»ä»‹è­·ï¼‰","ã‚µãƒ¼ãƒ“ã‚¹ä»˜ãé«˜é½¢è€…å‘ã‘ä½å®…ï¼ˆã‚µé«˜ä½ï¼‰","ä½å®…å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ","è»½è²»è€äººãƒ›ãƒ¼ãƒ ï¼ˆã‚±ã‚¢ãƒã‚¦ã‚¹ï¼‰","å¥åº·å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ","ã‚·ãƒ‹ã‚¢å‘ã‘åˆ†è­²ãƒãƒ³ã‚·ãƒ§ãƒ³"],
          "éšœå®³ç¦ç¥‰": ["æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹","ç”Ÿæ´»ä»‹è­·ï¼ˆéšœå®³è€…ã®æ—¥ä¸­æ´»å‹•ï¼‰","å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹","å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹","çŸ­æœŸå…¥æ‰€ï¼ˆéšœå®³è€…å‘ã‘ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰"],
          "æ­¯ç§‘": ["æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯","è¨ªå•æ­¯ç§‘","æ­¯ç§‘å£è…”å¤–ç§‘ï¼ˆç—…é™¢å†…è¨ºç™‚ç§‘ï¼‰","å¤§å­¦ç—…é™¢æ­¯ç§‘ãƒ»æ­¯å­¦éƒ¨é™„å±ç—…é™¢","æ­¯ç§‘æŠ€å·¥æ‰€","é™¢å†…ãƒ©ãƒœ"],
          "ãã®ä»–": ["ä¿è‚²åœ’","å¹¼ç¨šåœ’","ä¼æ¥­ï¼ˆç”£æ¥­ä¿å¥ãƒ»ä¼æ¥­å†…çœ‹è­·ãªã©ï¼‰"]
        },
        "å‹¤å‹™æ¡ä»¶": {
          "ä¼‘æ—¥": ["4é€±8ä¼‘ä»¥ä¸Š","è‚²å…æ”¯æ´ã‚ã‚Š","å¹´é–“ä¼‘æ—¥120æ—¥ä»¥ä¸Š","é€±1æ—¥ã‹ã‚‰OK","é€±2æ—¥ã‹ã‚‰OK","åœŸæ—¥ç¥ä¼‘ã¿","å®¶åº­éƒ½åˆä¼‘OK","æœˆ1ã‚·ãƒ•ãƒˆæå‡º","æ¯é€±ï½éš”é€±ã‚·ãƒ•ãƒˆæå‡º","æœ‰çµ¦æ¶ˆåŒ–ç‡ã»ã¼100%","é•·æœŸä¼‘æš‡ã‚ã‚Š","é€±ä¼‘2æ—¥","é€±ä¼‘3æ—¥"],
          "å‹¤å‹™æ™‚é–“": ["æ—¥å‹¤ã®ã¿å¯","å¤œå‹¤å°‚å¾“ã‚ã‚Š","2äº¤æ›¿åˆ¶","3äº¤æ›¿åˆ¶","åˆå‰ã®ã¿å‹¤å‹™","åˆå¾Œã®ã¿å‹¤å‹™","æ®‹æ¥­ã»ã¼ãªã—","ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ãªã—ãƒ»å…é™¤å¯","ç·Šæ€¥è¨ªå•ãªã—","æ™‚å·®å‡ºå‹¤å°å…¥","ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ åˆ¶åº¦ã‚ã‚Š","æ®‹æ¥­æœˆ20æ™‚é–“ä»¥å†…","ã‚¹ã‚­ãƒæ™‚é–“å‹¤å‹™","æ™‚çŸ­å‹¤å‹™ç›¸è«‡å¯"],
          "ã‚¢ã‚¯ã‚»ã‚¹": ["é§…è¿‘ï¼ˆ5åˆ†ä»¥å†…ï¼‰","è»Šé€šå‹¤å¯","ãƒã‚¤ã‚¯é€šå‹¤å¯","è‡ªè»¢è»Šé€šå‹¤å¯","é§è»Šå ´å®Œå‚™","ç›´è¡Œç›´å¸°OK"],
          "çµ¦ä¸ãƒ»è³ä¸": ["å¹´å300ä¸‡ä»¥ä¸Š","å¹´å350ä¸‡ä»¥ä¸Š","å¹´å400ä¸‡ä»¥ä¸Š","å¹´å450ä¸‡ä»¥ä¸Š","å¹´å500ä¸‡ä»¥ä¸Š","å¹´å550ä¸‡ä»¥ä¸Š","å¹´å600ä¸‡ä»¥ä¸Š","å¹´å650ä¸‡ä»¥ä¸Š","å¹´å700ä¸‡ä»¥ä¸Š","è³ä¸ã‚ã‚Š","é€€è·é‡‘ã‚ã‚Š"],
          "ç¦åˆ©åšç”Ÿ": ["å¯®ã‚ã‚Šãƒ»ç¤¾å®…ã‚ã‚Š","è¨—å…æ‰€ãƒ»ä¿è‚²æ”¯æ´ã‚ã‚Š","ç¤¾ä¼šä¿é™ºå®Œå‚™","äº¤é€šè²»æ”¯çµ¦","æ‰¶é¤Šæ§é™¤å†…è€ƒæ…®","å¾©è·æ”¯æ´","ä½å®…æ‰‹å½“","å‰¯æ¥­OK","æ—¥ãƒ»ç¥æ—¥çµ¦ä¸UP","å¼•è¶Šã—æ‰‹å½“","ç·Šæ€¥è¨ªå•æ™‚ã®æ‰‹å½“ãƒ»ä»£ä¼‘ã‚ã‚Š","ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè²¸ä¸ã‚ã‚Š","é›»å‹•ã‚¢ã‚·ã‚¹ãƒˆè‡ªè»¢è»Šãƒ»ãƒã‚¤ã‚¯ãƒ»è»Šè²¸ä¸","ç¤¾å‰²ã‚ã‚Š","ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆç›¸è«‡çª“å£ã‚ã‚Š"],
          "æ•™è‚²ä½“åˆ¶ãƒ»ç ”ä¿®åˆ¶åº¦": ["ç ”ä¿®åˆ¶åº¦ã‚ã‚Š","è³‡æ ¼å–å¾—æ”¯æ´ã‚ã‚Š","ã‚»ãƒŸãƒŠãƒ¼å‚åŠ è²»è£œåŠ©ã‚ã‚Š","ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Œå‚™","å‹•ç”»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š","è©•ä¾¡åˆ¶åº¦ã‚ã‚Š","ãƒ¡ãƒ³ã‚¿ãƒ¼åˆ¶åº¦ã‚ã‚Š","ç‹¬ç«‹ãƒ»é–‹æ¥­æ”¯æ´ã‚ã‚Š","é™¢é•·ãƒ»åˆ†é™¢é•·å€™è£œ","æ‹…å½“åˆ¶"]
        }
      }
    };

    const MUSTWANT_FLAT = (() => {
      const arr = [];
      const cats = MUSTWANT_DICT.categories;
      Object.keys(cats).forEach(main => {
        Object.values(cats[main]).forEach(list => arr.push(...list));
      });
      return arr;
    })();

    // ======== çŠ¶æ…‹ ========
    let currentStep = 0;
    let isNumberConfirmed = true; // ãƒ‡ãƒ¢ã§ã¯ç•ªå·ã‚’çœç•¥ã—ã€è·ç¨®ãƒ»å‹¤å‹™å…ˆã‹ã‚‰é–‹å§‹
    let deepDrill = 0;
    let awaiting = null; // 'reason'|'must'|'want' or null
    let pendingOptions = [];

    const session = {
      qualification: '',
      workplace: '',
      reasonTag: null,    // è»¢è·ç›®çš„ tag_labelï¼ˆå˜ä¸€ï¼‰
      mustTags: [],       // è¤‡æ•°
      wantTags: [],       // è¤‡æ•°
      canText: '',
      willText: '',
      memoUnmatched: []   // ä¼šè©±ã«ã¯å‡ºã•ãªã„
    };

    // ======== UI ========
    function updateProgressBar() {
      const pct = ((currentStep + 1) / 6) * 100;
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('current-step').textContent = currentStep + 1;
      document.getElementById('step-label').textContent = ['åŸºæœ¬æƒ…å ±','è»¢è·ç†ç”±','çµ¶å¯¾æ¡ä»¶','å¸Œæœ›æ¡ä»¶','çµŒé¨“','æŒ‘æˆ¦'][currentStep];
      document.getElementById('number-required').style.display = (currentStep===0 && !isNumberConfirmed) ? 'block':'none';
      updateChips();
    }

    function updateChips() {
      const cR = document.getElementById('chip-reason');
      const cM = document.getElementById('chip-must');
      const cW = document.getElementById('chip-want');
      if (session.reasonTag){ cR.textContent = 'è»¢è·ç†ç”±ï¼š' + session.reasonTag; cR.classList.remove('hidden','chip-ghost'); }
      else { cR.textContent = 'è»¢è·ç†ç”±ï¼šæœªè¨­å®š'; cR.classList.add('chip-ghost'); cR.classList.remove('hidden'); }
      cM.textContent = 'Mustï¼š' + session.mustTags.length + 'ä»¶';
      cM.classList.remove('hidden'); cM.classList.toggle('chip-ghost', session.mustTags.length===0);
      cW.textContent = 'Wantï¼š' + session.wantTags.length + 'ä»¶';
      cW.classList.remove('hidden'); cW.classList.toggle('chip-ghost', session.wantTags.length===0);
    }

    function addMessage(type, content) {
      const wrap = document.getElementById('messages');
      const row = document.createElement('div');
      row.className = 'flex ' + (type==='user'?'justify-end':'justify-start') + ' message-enter';
      row.innerHTML = `
        <div class="flex max-w-xs lg:max-w-2xl ${type==='user'?'flex-row-reverse':'flex-row'} items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${type==='user'?'bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 text-white':'bg-gradient-to-r from-gray-100 to-gray-200 border-2 border-white'}">
            ${type==='user'
              ? '<svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="7" r="4"></circle></svg>'
              : 'ğŸ¤–'}
          </div>
          <div class="rounded-2xl px-4 py-3 ${type==='user'?'bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 text-white ml-auto':'bg-white/90 text-slate-700 border border-pink-100/50'}">
            <div class="text-sm whitespace-pre-wrap leading-relaxed">${content}</div>
          </div>
        </div>`;
      wrap.appendChild(row);
      row.scrollIntoView({behavior:'smooth', block:'end'});
    }

    function showOptions(options, kind, hint='ã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿ') {
      // JSONã«å­˜åœ¨ã—ãªã„èªã¯æç¤ºã—ãªã„ï¼ˆã‚¬ãƒ¼ãƒ‰ï¼‰
      const opts = options.filter(o => kind==='reason' ? PURPOSE_TAGS.includes(o) : MUSTWANT_FLAT.includes(o));
      const unique = [...new Set(opts)].slice(0,3); // 2ã€œ3ä»¶å³å®ˆ
      if (unique.length===0) { hideOptions(); return false; }
      pendingOptions = unique; awaiting = kind;

      const box = document.getElementById('option-box');
      const hintEl = document.getElementById('option-hint');
      const area = document.getElementById('option-buttons');
      area.innerHTML = '';
      hintEl.textContent = hint;
      unique.forEach((label, idx) => {
        const b = document.createElement('button');
        b.className = 'btn chip';
        b.textContent = `ã€${label}ã€`;
        b.addEventListener('click', () => onPick(label));
        area.appendChild(b);
      });
      box.classList.remove('hidden');
      return true;
    }
    function hideOptions() {
      document.getElementById('option-box').classList.add('hidden');
      document.getElementById('option-buttons').innerHTML = '';
      pendingOptions = []; awaiting = null;
    }

    // ======== ãƒãƒƒãƒãƒ³ã‚° ========
    function countMatches(text, words) {
      const t = text.toLowerCase();
      return words.reduce((acc, w)=> acc + (t.includes(String(w).toLowerCase())?1:0), 0);
    }

    function pickReasonCategory(text) {
      // 8ã‚«ãƒ†ã‚´ãƒªã®ä¸­ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ãŒæœ€å¤šã®ã‚‚ã®ã‚’é¸ã¶ã€‚åŒç‚¹æ™‚ã¯ä¸Šä½2ã¤ã‚’è¿”ã™
      const scored = REASON_FLOW['è»¢è·ç†ç”±_åˆ†é¡ãƒ•ãƒ­ãƒ¼'].map(rec => ({
        cat: rec['ã‚«ãƒ†ã‚´ãƒª'],
        score: countMatches(text, rec['ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰']),
        options: rec['å†…éƒ¨å€™è£œ']
      })).sort((a,b)=>b.score-a.score);
      const top = scored.filter(s => s.score===scored[0].score && s.score>0);
      return top.length ? top : []; // 0ã®å ´åˆã¯æœªãƒãƒƒãƒ
    }

    function candidatesFromMustWant(text) {
      const t = text.toLowerCase();
      const scored = MUSTWANT_FLAT.map(item => {
        const low = item.toLowerCase();
        let s = 0;
        if (t.includes(low)) s += 3;
        // å˜èªãƒˆãƒ¼ã‚¯ãƒ³éƒ¨åˆ†ä¸€è‡´
        t.split(/[ \n\r\tã€ã€‚ãƒ»,ï¼Œã€‚!ï¼?ï¼Ÿ]+/).forEach(tok => { if (tok && low.includes(tok)) s += 1; });
        return {item, score:s};
      }).filter(x=>x.score>0)
        .sort((a,b)=>b.score-a.score).map(x=>x.item);
      return [...new Set(scored)].slice(0,3);
    }

    // ======== ä¼šè©±åˆ¶å¾¡ ========
    function empathyLine(step, text) {
      // ã‚·ãƒ³ãƒ—ãƒ«å›ºå®šï¼ˆJSONã‚„å†…éƒ¨èªã‚’å‡ºã•ãªã„ï¼‰
      if (step===1) return 'ãªã‚‹ã»ã©ã€ãã®æ°—æŒã¡ã‚ˆãã‚ã‹ã‚‹ï¼å¤§äº‹ãªè»¢è·ã®ãã£ã‹ã‘ã ã­â—';
      if (step===2) return 'ãã£ã‹ã€ã‚ã‹ã£ãŸï¼å¤§äº‹ãªå¸Œæœ›ã ã­â—';
      if (step===3) return 'äº†è§£ï¼æ°—æŒã¡ã¯å—ã‘å–ã£ãŸã‚ˆâ—';
      return 'OKï¼';
    }

    function onPick(label) {
      if (!awaiting) return;
      hideOptions();

      if (awaiting==='reason') {
        // ã‚¬ãƒ¼ãƒ‰ï¼šå¿…ãš PURPOSE_TAGS å†…
        if (!PURPOSE_TAGS.includes(label)) { addMessage('ai', empathyLine(1)); nextFromReason(); return; }
        addMessage('ai', `ãªã‚‹ã»ã©ã€ãã‚Œã¯å¤§äº‹ã ã‚ˆã­ï¼\nã¤ã¾ã‚Šã€${label}ã€ã£ã¦ã“ã¨ã ã­ï¼`);
        session.reasonTag = label;
        nextFromReason(true);
      } else if (awaiting==='must') {
        if (!MUSTWANT_FLAT.includes(label)) { addMessage('ai', empathyLine(2)); return; }
        addMessage('ai', `ãã£ã‹ã€ã€${label}ã€ãŒçµ¶å¯¾ã£ã¦ã“ã¨ã ã­ï¼`);
        session.mustTags.push(label);
        addMessage('ai', 'ä»–ã«ã‚‚çµ¶å¯¾æ¡ä»¶ã¯ã‚ã‚‹ï¼Ÿï¼ˆãªã‘ã‚Œã°ã€Œãªã„ã€ï¼‰');
      } else if (awaiting==='want') {
        if (!MUSTWANT_FLAT.includes(label)) { addMessage('ai', empathyLine(3)); return; }
        addMessage('ai', `äº†è§£ï¼ã€${label}ã€ã ã¨å¬‰ã—ã„ã£ã¦ã“ã¨ã ã­ï¼`);
        session.wantTags.push(label);
        addMessage('ai', 'ä»–ã«ã‚‚ã‚ã£ãŸã‚‰ã„ã„ãªã£ã¦ã„ã†ã®ã¯ã‚ã‚‹ï¼Ÿï¼ˆãªã‘ã‚Œã°ã€Œãªã„ã€ï¼‰');
      }
      updateProgressBar();
    }

    function nextFromReason(confirmed=false) {
      deepDrill = 0;
      currentStep = 2;
      updateProgressBar();
      const text =
`ã˜ã‚ƒã‚æ¬¡ã®è³ªå•ï¼
ä»Šå›ã®è»¢è·ã§ã“ã‚Œã ã‘ã¯çµ¶å¯¾è­²ã‚Œãªã„ï¼ã¨ã„ã†ã®ã‚’æ•™ãˆã¦ï¼
ä»•äº‹å†…å®¹ã§ã‚‚ã€åˆ¶åº¦ã§ã‚‚ã€æ¡ä»¶ã§ã‚‚OKâ—

ä¾‹ãˆã°ãƒ»ãƒ»ãƒ»
ã€Œçµ¶å¯¾åœŸæ—¥ä¼‘ã¿ã˜ã‚ƒãªã„ã¨å›°ã‚‹ï¼ã€
ã€Œçµ¶å¯¾ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ã¯ã§ããªã„ï¼ã€

å¾Œã‹ã‚‰ã€ã‚ã‚‹ã¨ã„ã„ãªã€ã€ãªã„ã¨ã„ã„ãªã€ã«ã¤ã„ã¦ã‚‚èãã‹ã‚‰ã€ä»Šã¯ã€çµ¶å¯¾ï¼ã€ã¨ã„ã†ã‚‚ã®ã ã‘æ•™ãˆã¦ã­ã€‚`;
      addMessage('ai', confirmed ? 'ã‚ã‚ŠãŒã¨ã†ï¼\n' + text : text);
    }

    async function processMessage(msg) {
      const message = String(msg||'').trim();
      if (!message) return;

      // é¸æŠè‚¢å¾…ã¡ä¸­ã¯ã€ã‚¯ãƒªãƒƒã‚¯ã§ã®ã¿å‡¦ç†ã™ã‚‹ï¼ˆå…¥åŠ›ã¯ä¿ƒã—ï¼‰
      if (awaiting) {
        addMessage('ai','ã”ã‚ã‚“ã€é¸æŠè‚¢ã‹ã‚‰é¸ã‚“ã§ã­ï¼');
        return;
      }

      // Step0ï¼šè·ç¨®ãƒ»å‹¤å‹™å…ˆï¼ˆè³‡æ ¼ã¯å†…éƒ¨å‚ç…§åŸŸã€‚ã“ã“ã§ã¯è‡ªç”±è¨˜è¿°â†’æ­£è¦åŒ–ã¯æ‹…å½“ã§ï¼‰
      if (currentStep===0) {
        session.qualification = message; // ã€Œä»Šã®è·ç¨®ã€
        addMessage('ai', 'OKã€ä»Šã®è·ç¨®ã‚ã‹ã£ãŸï¼æ¬¡ã«ã€Œä»Šã©ã“ã§åƒã„ã¦ã‚‹ï¼Ÿã€ã‚‚æ•™ãˆã¦ï¼');
        currentStep = 0.5; updateProgressBar(); return;
      }
      if (currentStep===0.5) {
        session.workplace = message;
        addMessage('ai', 'ã‚ã‚ŠãŒã¨ã†ï¼\nã¯ã˜ã‚ã«ã€ä»Šå›ã®è»¢è·ç†ç”±ã‚’æ•™ãˆã¦ã»ã—ã„ãªã€‚ãã£ã‹ã‘ã£ã¦ã©ã‚“ãªã“ã¨ã ã£ãŸï¼Ÿ\nã—ã‚“ã©ã„ã¨æ€ã£ãŸã“ã¨ã€ã“ã‚Œã¯ã‚‚ã†ç„¡ç†ã£ã¦æ€ã£ãŸã“ã¨ã€é€†ã«ã“ã†ã„ã†ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã„ï¼ã£ã¦æ€ã£ãŸã“ã¨ã€ä½•ã§ã‚‚OKã ã‚ˆâ—');
        currentStep = 1; updateProgressBar(); return;
      }

      // Step1ï¼šè»¢è·ç†ç”±ï¼ˆã‚«ãƒ†ã‚´ãƒªâ†’æ·±æ˜ã‚Š2å›â†’å€™è£œ2ã€œ3ä»¶æç¤º or æœªãƒãƒƒãƒå›ºå®šï¼‰
      if (currentStep===1) {
        const top = pickReasonCategory(message);
        if (top.length===0) {
          // å…¨ã‚«ãƒ†ã‚´ãƒªæœªãƒãƒƒãƒ
          addMessage('ai', empathyLine(1));
          nextFromReason(false);
          return;
        }
        // åŒç‚¹è¤‡æ•° â†’ ã©ã¡ã‚‰ãŒä¸»ã‹ç°¡æ˜“A/B
        if (top.length>1) {
          const a = top[0].cat, b = top[1].cat;
          addMessage('ai', `${a} ã¨ ${b}ã€ã©ã¡ã‚‰ã‚‚æ°—ã«ãªã£ã¦ã‚‹ã‚“ã ã­ã€‚\nã©ã¡ã‚‰ãŒä»Šå›ã®è»¢è·ã§ä¸€ç•ªé‡è¦ï¼Ÿ\nA) ${a}\nB) ${b}\nï¼ˆA ã¾ãŸã¯ B ã¨å…¥åŠ›ã—ã¦ã­ï¼‰`);
          currentStep = 1.1;
          window.__tie = {a:top[0], b:top[1], progress:0, history:[message]};
          return;
        }
        // å˜ç‹¬ãƒˆãƒƒãƒ—
        window.__cat = {rec: top[0], progress:1, history:[message]};
        if (deepDrill<2) {
          deepDrill++;
          addMessage('ai', deepDrill===1 ? 'ãã‚Œã«ã¤ã„ã¦ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã€‚' : 'å…·ä½“çš„ã«ã¯ã©ã‚“ãªï¼Ÿ');
          return;
        }
        // 3å›ç›® â†’ å€™è£œæç¤º or å†…éƒ¨å€™è£œç©ºãªã‚‰å›ºå®šç™ºè©±
        const opts = top[0].options || [];
        if (!opts || opts.length===0) {
          addMessage('ai', empathyLine(1)); // å†…éƒ¨å€™è£œãŒç©ºï¼šå›ºå®š
          nextFromReason(false);
          return;
        }
        showOptions(opts.slice(0,3), 'reason'); // 2ã€œ3ä»¶
        return;
      }

      // Step1 åŒç‚¹è§£æ±ºãƒ•ãƒ­ãƒ¼
      if (currentStep===1.1) {
        if (!window.__tie) { currentStep=1; return processMessage(message); }
        const pick = /^a\b/i.test(message)? window.__tie.a : (/^b\b/i.test(message)? window.__tie.b : null);
        if (!pick){ addMessage('ai','A ã‹ B ã‚’é¸ã‚“ã§ã­ï¼'); return; }
        window.__cat = {rec: pick, progress:1, history:window.__tie.history.concat(message)};
        window.__tie = null;
        if (deepDrill<2){ deepDrill++; addMessage('ai', deepDrill===1?'ãã‚Œã«ã¤ã„ã¦ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã€‚':'å…·ä½“çš„ã«ã¯ã©ã‚“ãªï¼Ÿ'); return; }
        const opts = (pick.options||[]);
        if (!opts.length){ addMessage('ai', empathyLine(1)); nextFromReason(false); return; }
        showOptions(opts.slice(0,3), 'reason'); return;
      }

      // Step2ï¼šMustï¼ˆ2å›æ·±æ˜ã‚Šâ†’å€™è£œæç¤ºâ†’ç¢ºå®šç¹°ã‚Šè¿”ã—ï¼‰
      if (currentStep===2) {
        if (/^ãªã„$|^ç„¡ã—$|^ãªã—$/i.test(message)) {
          addMessage('ai','ã‚ã‚ŠãŒã¨ã†ï¼ã˜ã‚ƒã‚æ¬¡ã¯ã€ã“ã†ã ã£ãŸã‚‰ã„ã„ãªã€ã¨ã„ã†å¸Œæœ›ã‚’æ•™ãˆã¦ï¼');
          currentStep = 3; updateProgressBar(); return;
        }
        // ãƒãƒƒãƒæ¢ç´¢
        if (!window.__must){ window.__must = {drill:0}; }
        const cand = candidatesFromMustWant(message);
        if (cand.length>=1) { showOptions(cand, 'must', 'ã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿ'); return; }
        // æ·±æ˜ã‚Š
        if (window.__must.drill<2) {
          window.__must.drill++;
          addMessage('ai', window.__must.drill===1?'å¯¾è±¡ã‚„æ¡ä»¶ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚‚ã†å°‘ã—å…·ä½“çš„ã«æ•™ãˆã¦ï¼':'é »åº¦ã‚„æ°´æº–ã¯ã©ã®ãã‚‰ã„ã‚’æƒ³å®šã—ã¦ã‚‹ï¼Ÿ');
          return;
        }
        // 3å›ç›®â†’å€™è£œå‡ºã›ãªã„â†’æœªãƒãƒƒãƒå›ºå®š
        addMessage('ai', empathyLine(2));
        addMessage('ai','ä»–ã«ã‚‚çµ¶å¯¾æ¡ä»¶ã¯ã‚ã‚‹ï¼Ÿï¼ˆãªã‘ã‚Œã°ã€Œãªã„ã€ï¼‰');
        session.memoUnmatched.push({step:2, text:message});
        return;
      }

      // Step3ï¼šWantï¼ˆ2å›æ·±æ˜ã‚Šâ†’å€™è£œæç¤ºâ†’ç¢ºå®šç¹°ã‚Šè¿”ã—ï¼‰
      if (currentStep===3) {
        if (/^ãªã„$|^ç„¡ã—$|^ãªã—$/i.test(message)) {
          // æ¬¡ã¸
          addMessage('ai','è³ªå•ã¯æ®‹ã‚Š2ã¤ï¼\nã‚ã¨å°‘ã—ã ã‹ã‚‰ã€é ‘å¼µã£ã¦ğŸ˜†âœ¨ï¸\n\næ¬¡ã«æ•™ãˆã¦æ¬²ã—ã„ã®ã¯ã€ã“ã‚Œã¾ã§ã‚„ã£ã¦ããŸã“ã¨ã€ã€‚\nã“ã“ã¯æ¬¡å›æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã—ã£ã‹ã‚Šãƒ’ã‚¢ãƒªãƒ³ã‚°ã—ã¦ã„ãã‹ã‚‰ã€ã–ã£ãã‚Šã§OKã ã‚ˆã€‚ã“ã‚Œã‹ã‚‰ã‚‚æ´»ã‹ã—ãŸã„ã“ã¨ã‚’æ•™ãˆã¦ã­ã€‚');
          currentStep = 4; updateProgressBar(); return;
        }
        if (!window.__want){ window.__want = {drill:0}; }
        const cand = candidatesFromMustWant(message);
        if (cand.length>=1) { showOptions(cand, 'want', 'ã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿ'); return; }
        if (window.__want.drill<2) {
          window.__want.drill++;
          addMessage('ai', window.__want.drill===1?'å¯¾è±¡ã‚„æ¡ä»¶ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚‚ã†å°‘ã—å…·ä½“çš„ã«æ•™ãˆã¦ï¼':'é »åº¦ã‚„æ°´æº–ã¯ã©ã®ãã‚‰ã„ã‚’æƒ³å®šã—ã¦ã‚‹ï¼Ÿ');
          return;
        }
        addMessage('ai', empathyLine(3));
        addMessage('ai','ä»–ã«ã‚‚ã‚ã£ãŸã‚‰ã„ã„ãªã£ã¦ã„ã†ã®ã¯ã‚ã‚‹ï¼Ÿï¼ˆãªã‘ã‚Œã°ã€Œãªã„ã€ï¼‰');
        session.memoUnmatched.push({step:3, text:message});
        return;
      }

      // Step4ï¼šCanï¼ˆãƒ†ã‚­ã‚¹ãƒˆä¿å­˜ã®ã¿ï¼‰
      if (currentStep===4) {
        session.canText = message;
        addMessage('ai','ã„ã„ã­ï¼');
        addMessage('ai','ã“ã‚ŒãŒæœ€å¾Œã®è³ªå•ğŸ‘\nä»Šå›ã®è»¢è·ã§å¶ãˆãŸã„æŒ‘æˆ¦ã‚„ã€å¤¢ã¯ã‚ã‚‹ï¼Ÿ');
        currentStep = 5; updateProgressBar(); return;
      }

      // Step5ï¼šWillï¼ˆãƒ†ã‚­ã‚¹ãƒˆä¿å­˜ã®ã¿â†’ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰
      if (currentStep===5) {
        session.willText = message;
        currentStep = 6; updateProgressBar();
        const summary =
`ä»Šæ—¥ã¯ãŸãã•ã‚“è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼
ã“ã“ã¾ã§ã®å†…å®¹ã‚’æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å¼•ãç¶™ãã­ã€‚
æ¬¡å›ã®é¢è«‡ã§ä¸€ç·’ã«è©°ã‚ã¦ã„ã“ã†ï¼

ğŸ“‹ åé›†ãƒ‡ãƒ¼ã‚¿ï¼ˆå†…éƒ¨ä¿å­˜ï¼‰
è»¢è·ç†ç”±ã‚¿ã‚°ï¼š${session.reasonTag || 'æœªè¨­å®š'}
Mustï¼š${session.mustTags.length? session.mustTags.join('ã€'):'æœªè¨­å®š'}
Wantï¼š${session.wantTags.length? session.wantTags.join('ã€'):'æœªè¨­å®š'}
æ´»ã‹ã—ãŸã„çµŒé¨“ï¼ˆåŸæ–‡ï¼‰ï¼š${session.canText || 'æœªå…¥åŠ›'}
æŒ‘æˆ¦ã—ãŸã„ã“ã¨ï¼ˆåŸæ–‡ï¼‰ï¼š${session.willText || 'æœªå…¥åŠ›'}`;
        addMessage('ai', summary);
        return;
      }
    }

    // ======== é€ä¿¡æ“ä½œ ========
    document.getElementById('send-button').addEventListener('click', () => {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text) return;
      addMessage('user', text);
      input.value = '';
      processMessage(text);
    });
    document.getElementById('message-input').addEventListener('keypress', (e) => {
      if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('send-button').click(); }
    });

    // åˆæœŸåŒ–
    updateProgressBar();
  </script>
</body>
</html>
