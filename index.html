<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>HOAP AI キャリアエージェント</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .gradient-bg{background:linear-gradient(135deg,#fdf2f8 0%,#faf5ff 50%,#eff6ff 100%)}
  .gradient-text{background:linear-gradient(135deg,#ec4899 0%,#8b5cf6 50%,#3b82f6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .message-enter{animation:slideIn .22s ease-out}
  @keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .btn{cursor:pointer;transition:transform .06s ease}
  .btn:active{transform:scale(.98)}
  .chip{display:inline-flex;align-items:center;border:1px solid rgba(236,72,153,.25);background:#fff;border-radius:9999px;padding:.3rem .65rem;margin:.2rem .3rem .2rem 0}
  .chip-ghost{border:1px dashed rgba(99,102,241,.5);background:rgba(255,255,255,.6)}
  .chips{margin-top:.5rem}
</style>
</head>
<body class="gradient-bg min-h-screen text-slate-800">
  <!-- Header -->
  <div class="bg-white/90 backdrop-blur-sm border-b border-pink-100 sticky top-0 z-10 shadow-sm">
    <div class="max-w-4xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold gradient-text">HOAP AI エージェント</h1>
          <p class="text-slate-600 text-sm">一次ヒアリング（番号必須・タグ厳密整合）</p>
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-500">Step <span id="current-step">1</span>/6</div>
          <div class="text-xs gradient-text font-medium">
            <span id="step-label">基本情報</span>
            <span id="number-required" class="block text-red-400 text-xs mt-1">※求職者番号必須</span>
          </div>
        </div>
      </div>
      <div class="mt-3 bg-gradient-to-r from-pink-100 to-blue-100 rounded-full h-1">
        <div id="progress-bar" class="bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 h-1 rounded-full transition-all duration-500" style="width:16.67%"></div>
      </div>
      <div class="mt-4 text-sm">
        <div class="text-slate-500">確定状況（内部要約）</div>
        <div class="chips">
          <span id="chip-id"   class="chip chip-ghost">番号：未入力</span>
          <span id="chip-qual" class="chip chip-ghost">職種：未入力</span>
          <span id="chip-work" class="chip chip-ghost">勤務先：未入力</span>
          <span id="chip-reason" class="chip chip-ghost">転職理由：未設定</span>
          <span id="chip-must"   class="chip chip-ghost">Must：0件</span>
          <span id="chip-want"   class="chip chip-ghost">Want：0件</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat -->
  <div class="max-w-4xl mx-auto px-6 py-8 pb-32">
    <div id="messages" class="space-y-6">
      <!-- 初期メッセージ -->
      <div class="flex justify-start">
        <div class="flex max-w-xs lg:max-w-2xl items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 shadow-md border-2 border-white flex items-center justify-center">🤖</div>
          <div class="bg-white/90 backdrop-blur-sm text-slate-700 border border-pink-100/50 rounded-2xl px-4 py-3 shadow-sm">
            <div class="text-sm whitespace-pre-wrap leading-relaxed text-left">
こんにちは！
担当エージェントとの面談がスムーズに進むように、HOAPのAIエージェントに少しだけ話を聞かせてね。

いくつか質問をしていくね。
担当エージェントとの面談でしっかりヒアリングするから、今日は自分の転職について改めて整理する感じで、気楽に話してね！

まず3つ教えて！
①求職者番号（※半角数字）②今の職種③今どこで働いてる？
※一度に書いてもOK（例：12345 看護師 総合病院）
            </div>
          </div>
        </div>
      </div>

      <!-- 候補ボックス -->
      <div id="option-box" class="hidden">
        <div class="mt-2 rounded-2xl border border-pink-200 bg-white/90 px-4 py-3 shadow-sm">
          <div class="text-xs text-slate-500 mb-2" id="option-hint">このあたりが近そう。選んでもいいし、そのまま続けてもOKだよ。</div>
          <div id="option-buttons" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-pink-100/50 shadow-xl">
    <div class="max-w-4xl mx-auto px-6 py-4">
      <div class="flex items-end gap-3">
        <div class="flex-1 relative">
          <textarea id="message-input" placeholder="メッセージを入力..." class="w-full bg-white border border-pink-200 rounded-xl px-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent resize-none min-h-[52px] max-h-32 shadow-sm"></textarea>
        </div>
        <button id="send-button" class="btn bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 hover:from-pink-600 hover:via-purple-600 hover:to-blue-600 text-white rounded-xl p-3 shadow-lg">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22,2 15,22 11,13 2,9"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>
<script>
// --- 超シンプル：表示と送信だけ（会話は全部GPTが担当） ---
function addMessage(type, content){
  const wrap=document.getElementById('messages');
  const row=document.createElement('div');
  row.className='flex '+(type==='user'?'justify-end':'justify-start')+' message-enter';
  row.innerHTML=`
    <div class="flex max-w-xs lg:max-w-2xl ${type==='user'?'flex-row-reverse':'flex-row'} items-start gap-3">
      <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${
        type==='user'
        ? 'bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 text-white'
        : 'bg-gradient-to-r from-gray-100 to-gray-200 border-2 border-white'
      }">
        ${type==='user' ? '👤' : '🤖'}
      </div>
      <div class="rounded-2xl px-4 py-3 ${
        type==='user'
        ? 'bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 text-white ml-auto'
        : 'bg-white/90 text-slate-700 border border-pink-100/50'
      }">
        <div class="text-sm whitespace-pre-wrap leading-relaxed">${content}</div>
      </div>
    </div>`;
  wrap.appendChild(row);
  row.scrollIntoView({behavior:'smooth',block:'end'});
}

// 履歴（そのまま投げる）
window.chatHistory = window.chatHistory || [];

// GPTに投げるだけ。進行・ルールはGPTが全て決める
async function processMessage(raw){
  const message = String(raw||'').trim();
  if(!message) return;

  addMessage('user', message);

  try{
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, history: window.chatHistory })
    });

    const data = await res.json();
    const reply = data?.reply || '（応答が取れなかった…）';
    addMessage('ai', reply);

    window.chatHistory.push({ role:'user', content: message });
    window.chatHistory.push({ role:'assistant', content: reply });

  }catch(e){
    addMessage('ai','（サーバーに接続できないみたい…）');
  }
}

// 入出力イベント
document.getElementById('send-button').addEventListener('click', async ()=>{
  const input=document.getElementById('message-input');
  const msg=input.value.trim();
  if(!msg) return;
  input.value='';
  await processMessage(msg);
});
document.getElementById('message-input').addEventListener('keypress',(e)=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    document.getElementById('send-button').click();
  }
});
</script>
</body>
</html>
