// ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰åœŸå°ç‰ˆï¼šãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ï¼ã‚µãƒ¼ãƒãƒ¼å›ºå®šã€æ–‡é¢æ•´å½¢ã¯ä»»æ„ã§GPTã«å§”è­²
import OpenAI from 'openai'
const usePolish = process.env.POLISH_WITH_GPT === 'true'
const openai = usePolish ? new OpenAI({ apiKey: process.env.OPENAI_API_KEY }) : null

// ===== ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ =====
const transferReasonFlow = {
  'çµŒå–¶ãƒ»çµ„ç¹”ã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['ç†å¿µ','æ–¹é‡','ä¾¡å€¤è¦³','çµŒå–¶','é‹å–¶','ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ','æ–¹å‘æ€§','ãƒ“ã‚¸ãƒ§ãƒ³','ãƒŸãƒƒã‚·ãƒ§ãƒ³','è€ƒãˆæ–¹','å§¿å‹¢','çµŒå–¶é™£','ãƒˆãƒƒãƒ—','é¢¨é€šã—','æ„è¦‹','ç™ºè¨€','è©•ä¾¡åˆ¶åº¦','è©•ä¾¡','æ˜‡çµ¦','æ˜‡æ ¼','å…¬å¹³','åŸºæº–','æ•™è‚²ä½“åˆ¶','ç ”ä¿®','ãƒãƒ‹ãƒ¥ã‚¢ãƒ«','OJT','ãƒ•ã‚©ãƒ­ãƒ¼','æ•™è‚²','ã‚µãƒãƒ¼ãƒˆ','çµŒå–¶è€…','åŒ»ç™‚è·','ç¾å ´ç†è§£','å£²ä¸Š','æ•°å­—'],
    internal_options: ['MVVãƒ»çµŒå–¶ç†å¿µã«å…±æ„Ÿã§ãã‚‹è·å ´ã§åƒããŸã„','é¢¨é€šã—ãŒã‚ˆãæ„è¦‹ãŒè¨€ã„ã‚„ã™ã„è·å ´ã§åƒããŸã„','è©•ä¾¡åˆ¶åº¦ãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„','æ•™è‚²ä½“åˆ¶ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„','çµŒå–¶è€…ãŒåŒ»ç™‚è·ã®ã¨ã“ã‚ã§åƒããŸã„','çµŒå–¶è€…ãŒåŒ»ç™‚è·ã§ã¯ãªã„ã¨ã“ã‚ã§åƒããŸã„']
  },
  'åƒãä»²é–“ã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['äººé–“é–¢ä¿‚','è·å ´ã®é›°å›²æ°—','ä¸Šå¸','å…ˆè¼©','åŒåƒš','ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯','ã„ã˜ã‚','ãƒ‘ãƒ¯ãƒãƒ©','ã‚»ã‚¯ãƒãƒ©','é™°å£','æ´¾é–¥','ãŠå±€','ç†ä¸å°½','ç›¸è«‡ã§ããªã„','å­¤ç«‹','ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³','ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«','å°Šæ•¬','æ†§ã‚Œ','è¦‹ç¿’ã„ãŸã„','ä¾¡å€¤è¦³','æ¸©åº¦æ„Ÿ','ã‚„ã‚‹æ°—','ä¿¡é ¼','å“æ ¼','ä¸€è²«æ€§','ç›®æ¨™','æ‰‹æœ¬','è·ç¨®','é€£æº','åŠ©ã‘åˆã„','å£','åˆ†æ–­','å¤æ ª','æ¨©åŠ›','åœ§','æ”¯é…'],
    internal_options: ['äººé–“é–¢ä¿‚ã®ãƒˆãƒ©ãƒ–ãƒ«ãŒå°‘ãªã„è·å ´ã§åƒããŸã„','åŒã˜ä¾¡å€¤è¦³ã‚’æŒã¤ä»²é–“ã¨åƒããŸã„','å°Šæ•¬ã§ãã‚‹ä¸Šå¸ãƒ»çµŒå–¶è€…ã¨åƒããŸã„','ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ãªã‚‹ä¸Šå¸ã‚„å…ˆè¼©ãŒã»ã—ã„','è·ç¨®é–¢ä¿‚ãªãä¸€ä½“æ„ŸãŒã‚ã‚‹ä»²é–“ã¨åƒããŸã„','ãŠå±€ãŒã„ãªã„è·å ´ã§åƒããŸã„']
  },
  'ä»•äº‹å†…å®¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—','æˆé•·','æŒ‘æˆ¦','ã‚„ã‚ŠãŒã„','æ¥­å‹™å†…å®¹','å°‚é–€æ€§','ç ”ä¿®','æ•™è‚²','ã‚­ãƒ£ãƒªã‚¢','æ˜‡é€²','æ˜‡æ ¼','è³‡æ ¼å–å¾—','çµŒé¨“','å­¦ã¹ã‚‹','æ–°ã—ã„','å¹…ã‚’åºƒã’ã‚‹','å¼·ã¿','æ´»ã‹ã™','è³‡æ ¼','å¾—æ„','æœªçµŒé¨“','åˆ†é‡','æ‚£è€…','åˆ©ç”¨è€…','è²¢çŒ®','å®Ÿæ„Ÿ','æ›¸é¡','ä»¶æ•°','å½¹ç«‹ã¤','ã‚ã‚ŠãŒã¨ã†','è²¬ä»»','å½¹è·','æ©Ÿä¼š','é“ç­‹','ç™»ç”¨'],
    internal_options: ['ä»Šã¾ã§ã®çµŒé¨“ã‚„è‡ªåˆ†ã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸã„','æœªçµŒé¨“ã®ä»•äº‹ï¼åˆ†é‡ã«æŒ‘æˆ¦ã—ãŸã„','ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸã„','æ‚£è€…ãƒ»åˆ©ç”¨è€…ã¸ã®è²¢çŒ®å®Ÿæ„Ÿã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ä»•äº‹ã«æºã‚ã‚Œã‚‹','æ˜‡é€²ãƒ»æ˜‡æ ¼ã®æ©Ÿä¼šãŒã‚ã‚‹']
  },
  'åŠ´åƒæ¡ä»¶ã«é–¢ã™ã‚‹ã“ã¨': { keywords: ['æ®‹æ¥­','å¤œå‹¤','ä¼‘æ—¥','æœ‰çµ¦','åƒãæ–¹','æ™‚é–“','ã‚·ãƒ•ãƒˆ','å‹¤å‹™æ™‚é–“','é€£å‹¤','ä¼‘æ†©','ã‚ªãƒ³ã‚³ãƒ¼ãƒ«','å‘¼ã³å‡ºã—','å‰¯æ¥­','å…¼æ¥­','ç¤¾ä¼šä¿é™º','ä¿é™º','å¥ä¿','åšç”Ÿå¹´é‡‘','è¨ºç™‚æ™‚é–“','è‡ªå·±ç ”é‘½','å‹‰å¼·','å­¦ç¿’','ç ”ä¿®æ™‚é–“','ç›´è¡Œç›´å¸°','äº‹å‹™æ‰€','ç«‹ã¡å¯„ã‚Š','æœç¤¼','æ—¥å ±','å®šæ™‚','ã‚µãƒ¼ãƒ“ã‚¹æ®‹æ¥­','ç”³è«‹åˆ¶','äººå“¡é…ç½®','å¸Œæœ›æ—¥','åŠä¼‘','æ™‚é–“æœ‰ä¼‘','æ‰¿èª','å°±æ¥­è¦å‰‡','å…¼æ¥­','è¨±å¯','å¥åº·ä¿é™º','é›‡ç”¨ä¿é™º','åŠ´ç½','æ‰‹ç¶šã','å§‹æ¥­å‰','æº–å‚™','æ¸…æƒ','æ‰“åˆ»'], internal_options: [] },
  'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«é–¢ã™ã‚‹ã“ã¨': { keywords: ['å®¶åº­','è‚²å…','å­è‚²ã¦','ä¸¡ç«‹','ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸','å­ã©ã‚‚','å®¶æ—','ä»‹è­·','ä¿è‚²åœ’','é€è¿','å­¦æ ¡è¡Œäº‹','é€šé™¢','ç™ºç†±','ä¸­æŠœã‘','æ™‚çŸ­','ã‚¤ãƒ™ãƒ³ãƒˆ','é£²ã¿ä¼š','BBQ','ç¤¾å“¡æ—…è¡Œ','æ—©æœæ¸…æƒ','å¼·åˆ¶','æ¥­å‹™å¤–','å°±æ¥­å¾Œ','ä¼‘æ—¥','ã‚ªãƒ•','ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ','ä»²è‰¯ã','äº¤æµ','ã”ã¯ã‚“','è¶£å‘³'], internal_options: ['å®¶åº­ã¨ã®ä¸¡ç«‹ã«ç†è§£ã®ã‚ã‚‹è·å ´ã§åƒããŸã„','å‹¤å‹™æ™‚é–“å¤–ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„è·å ´ã§åƒããŸã„','ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§ã‚‚ä»²è‰¯ãã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„'] },
  'è·å ´ç’°å¢ƒãƒ»è¨­å‚™': { keywords: ['è¨­å‚™','ç’°å¢ƒ','æ–½è¨­','å™¨æ¢°','æ©Ÿå™¨','ã‚·ã‚¹ãƒ†ãƒ ','IT','ãƒ‡ã‚¸ã‚¿ãƒ«','å¤ã„','æ–°ã—ã„','æœ€æ–°','è¨­ç½®','å°å…¥','æ•´å‚™'], internal_options: [] },
  'è·å ´ã®å®‰å®šæ€§': { keywords: ['å®‰å®š','å°†æ¥æ€§','çµŒå–¶çŠ¶æ³','å€’ç”£','ãƒªã‚¹ãƒˆãƒ©','ä¸å®‰','ç¶™ç¶š','æŒç¶š','æˆé•·','ç™ºå±•','å°†æ¥','å…ˆè¡Œã'], internal_options: [] },
  'çµ¦ä¸ãƒ»å¾…é‡': { keywords: ['çµ¦æ–™','çµ¦ä¸','å¹´å','æœˆå','æ‰‹å–ã‚Š','è³ä¸','ãƒœãƒ¼ãƒŠã‚¹','æ˜‡çµ¦','æ‰‹å½“','å¾…é‡','ç¦åˆ©åšç”Ÿ','å®‰ã„','ä½ã„','ä¸ŠãŒã‚‰ãªã„','ç”Ÿæ´»ã§ããªã„','ãŠé‡‘'], internal_options: [] }
}

const mustWantItems = [/* æ—¢å­˜ã®é•·ã„é…åˆ—ãã®ã¾ã¾ */ 
  'æ€¥æ€§æœŸç—…æ£Ÿ','å›å¾©æœŸç—…æ£Ÿ','æ…¢æ€§æœŸãƒ»ç™‚é¤Šå‹ç—…é™¢','ä¸€èˆ¬ç—…é™¢','åœ°åŸŸåŒ…æ‹¬ã‚±ã‚¢ç—…æ£Ÿ','ç™‚é¤Šç—…æ£Ÿ',
  'ç·©å’Œã‚±ã‚¢ç—…æ£Ÿï¼ˆãƒ›ã‚¹ãƒ”ã‚¹ï¼‰','ã‚¯ãƒªãƒ‹ãƒƒã‚¯','ç²¾ç¥ç§‘ç—…é™¢','è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³','ç²¾ç¥ç§‘ç‰¹åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
  'æ©Ÿèƒ½å¼·åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³','è¨ªå•ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³','è¨ªå•æ „é¤ŠæŒ‡å°','é€šæ‰€ä»‹è­·ï¼ˆãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰',
  'èªçŸ¥ç—‡å¯¾å¿œå‹é€šæ‰€ä»‹è­·ï¼ˆèªçŸ¥ç—‡å°‚é–€ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰','åœ°åŸŸå¯†ç€å‹é€šæ‰€ä»‹è­·ï¼ˆå®šå“¡18åä»¥ä¸‹ï¼‰','é€šæ‰€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ã‚¤ã‚±ã‚¢ï¼‰',
  'è¨ªå•ä»‹è­·','å®šæœŸå·¡å›ãƒ»éšæ™‚å¯¾å¿œå‹è¨ªå•ä»‹è­·çœ‹è­·','è¨ªå•å…¥æµ´','å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·','çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·',
  'ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ','åœ°åŸŸå¯†ç€å‹ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ï¼ˆå®šå“¡29åä»¥ä¸‹ï¼‰','ä»‹è­·è€äººä¿å¥æ–½è¨­','ä»‹è­·ä»˜ãæœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ',
  'ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼ˆçŸ­æœŸå…¥æ‰€ç”Ÿæ´»ä»‹è­·ï¼‰','ã‚µãƒ¼ãƒ“ã‚¹ä»˜ãé«˜é½¢è€…å‘ã‘ä½å®…ï¼ˆã‚µé«˜ä½ï¼‰','ä½å®…å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ','è»½è²»è€äººãƒ›ãƒ¼ãƒ ï¼ˆã‚±ã‚¢ãƒã‚¦ã‚¹ï¼‰',
  'å¥åº·å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ','ã‚·ãƒ‹ã‚¢å‘ã‘åˆ†è­²ãƒãƒ³ã‚·ãƒ§ãƒ³','æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹','ç”Ÿæ´»ä»‹è­·ï¼ˆéšœå®³è€…ã®æ—¥ä¸­æ´»å‹•ï¼‰',
  'å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹','å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹','çŸ­æœŸå…¥æ‰€ï¼ˆéšœå®³è€…å‘ã‘ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰','æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','è¨ªå•æ­¯ç§‘',
  'æ­¯ç§‘å£è…”å¤–ç§‘ï¼ˆç—…é™¢å†…è¨ºç™‚ç§‘ï¼‰','å¤§å­¦ç—…é™¢æ­¯ç§‘ãƒ»æ­¯å­¦éƒ¨é™„å±ç—…é™¢','æ­¯ç§‘æŠ€å·¥æ‰€','é™¢å†…ãƒ©ãƒœ','ä¿è‚²åœ’','å¹¼ç¨šåœ’',
  'ä¼æ¥­ï¼ˆç”£æ¥­ä¿å¥ãƒ»ä¼æ¥­å†…çœ‹è­·ãªã©ï¼‰','4é€±8ä¼‘ä»¥ä¸Š','è‚²å…æ”¯æ´ã‚ã‚Š','å¹´é–“ä¼‘æ—¥120æ—¥ä»¥ä¸Š','é€±1æ—¥ã‹ã‚‰OK','é€±2æ—¥ã‹ã‚‰OK',
  'åœŸæ—¥ç¥ä¼‘ã¿','å®¶åº­éƒ½åˆä¼‘OK','æœˆ1ã‚·ãƒ•ãƒˆæå‡º','æ¯é€±ã€œéš”é€±ã‚·ãƒ•ãƒˆæå‡º','æœ‰çµ¦æ¶ˆåŒ–ç‡ã»ã¼100%','é•·æœŸä¼‘æš‡ã‚ã‚Š','é€±ä¼‘2æ—¥','é€±ä¼‘3æ—¥',
  'æ—¥å‹¤ã®ã¿å¯','å¤œå‹¤å°‚å¾“ã‚ã‚Š','2äº¤æ›¿åˆ¶','3äº¤æ›¿åˆ¶','åˆå‰ã®ã¿å‹¤å‹™','åˆå¾Œã®ã¿å‹¤å‹™','æ®‹æ¥­ã»ã¼ãªã—','ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ãªã—ãƒ»å…é™¤å¯',
  'ç·Šæ€¥è¨ªå•ãªã—','æ™‚å·®å‡ºå‹¤å°å…¥','ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ åˆ¶åº¦ã‚ã‚Š','æ®‹æ¥­æœˆ20æ™‚é–“ä»¥å†…','ã‚¹ã‚­ãƒæ™‚é–“å‹¤å‹™','æ™‚çŸ­å‹¤å‹™ç›¸è«‡å¯','é§…è¿‘ï¼ˆ5åˆ†ä»¥å†…ï¼‰',
  'è»Šé€šå‹¤å¯','ãƒã‚¤ã‚¯é€šå‹¤å¯','è‡ªè»¢è»Šé€šå‹¤å¯','é§è»Šå ´å®Œå‚™','ç›´è¡Œç›´å¸°OK','å¹´å300ä¸‡ä»¥ä¸Š','å¹´å350ä¸‡ä»¥ä¸Š','å¹´å400ä¸‡ä»¥ä¸Š',
  'å¹´å450ä¸‡ä»¥ä¸Š','å¹´å500ä¸‡ä»¥ä¸Š','å¹´å550ä¸‡ä»¥ä¸Š','å¹´å600ä¸‡ä»¥ä¸Š','å¹´å650ä¸‡ä»¥ä¸Š','å¹´å700ä¸‡ä»¥ä¸Š','è³ä¸ã‚ã‚Š','é€€è·é‡‘ã‚ã‚Š',
  'å¯®ã‚ã‚Šãƒ»ç¤¾å®…ã‚ã‚Š','è¨—å…æ‰€ãƒ»ä¿è‚²æ”¯æ´ã‚ã‚Š','ç¤¾ä¼šä¿é™ºå®Œå‚™','äº¤é€šè²»æ”¯çµ¦','æ‰¶é¤Šæ§é™¤å†…è€ƒæ…®','å¾©è·æ”¯æ´','ä½å®…æ‰‹å½“','å‰¯æ¥­OK',
  'æ—¥ãƒ»ç¥æ—¥çµ¦ä¸UP','å¼•è¶Šã—æ‰‹å½“','ç·Šæ€¥è¨ªå•æ™‚ã®æ‰‹å½“ãƒ»ä»£ä¼‘ã‚ã‚Š','ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè²¸ä¸ã‚ã‚Š','é›»å‹•ã‚¢ã‚·ã‚¹ãƒˆè‡ªè»¢è»Šãƒ»ãƒã‚¤ã‚¯ãƒ»è»Šè²¸ä¸',
  'ç¤¾å‰²ã‚ã‚Š','ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆç›¸è«‡çª“å£ã‚ã‚Š','ç ”ä¿®åˆ¶åº¦ã‚ã‚Š','è³‡æ ¼å–å¾—æ”¯æ´ã‚ã‚Š','ã‚»ãƒŸãƒŠãƒ¼å‚åŠ è²»è£œåŠ©ã‚ã‚Š','ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Œå‚™','å‹•ç”»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š',
  'è©•ä¾¡åˆ¶åº¦ã‚ã‚Š','ãƒ¡ãƒ³ã‚¿ãƒ¼åˆ¶åº¦ã‚ã‚Š','ç‹¬ç«‹ãƒ»é–‹æ¥­æ”¯æ´ã‚ã‚Š','é™¢é•·ãƒ»åˆ†é™¢é•·å€™è£œ','æ‹…å½“åˆ¶'
]

// ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³ =====
const sessions = new Map()
function getSession(id) {
  if (!sessions.has(id)) {
    sessions.set(id, {
      candidateNumber: '', qualification: '', workplace: '',
      transferReason: '', mustConditions: [], ngConditions: [],
      canDo: '', willDo: '',
      currentCategory: null, awaitingSelection: false, selectionOptions: []
    })
  }
  return sessions.get(id)
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function detectCategory(text) {
  const hits = []
  for (const [cat, cfg] of Object.entries(transferReasonFlow)) {
    const found = cfg.keywords.filter(kw => text.includes(kw))
    if (found.length) hits.push({ cat, score: found.length, keywords: found })
  }
  hits.sort((a,b)=>b.score-a.score)
  return hits[0] || null
}
function pickOptions(cat) {
  const opts = transferReasonFlow[cat]?.internal_options || []
  if (!opts.length) return []
  const shuffled = [...opts].sort(()=>Math.random()-0.5)
  return shuffled.slice(0, Math.min(3, opts.length))
}
function matchDict(text) {
  const out = []
  for (const w of mustWantItems) if (text.includes(w)) out.push(w)
  return [...new Set(out)]
}

// ===== æ–‡é¢æ•´å½¢ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã®ã‚³ã‚¢ï¼‰ =====
async function polish(text) {
  if (!usePolish || !openai) return text
  try {
    const r = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'system', content: 'ã‚ãªãŸã¯ä¸å¯§ã™ããªã„ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ—¥æœ¬èªã®ç·¨é›†è€…ã€‚æ„å‘³ã‚’å¤‰ãˆãšã«è¨€ã„å›ã—ã ã‘è‡ªç„¶ã«æ•´ãˆã‚‹ã€‚çµµæ–‡å­—ã‚„é¡”æ–‡å­—ã¯å¢—ã‚„ã•ãªã„ã€‚' },
        { role: 'user', content: text }
      ],
      temperature: 0.2,
      max_tokens: 300
    })
    return (r.choices?.[0]?.message?.content || text).trim()
  } catch {
    return text
  }
}
async function respond(res, text, step, extra = {}) {
  const msg = await polish(text)
  return res.json({ response: msg, step, ...extra })
}

// ===== ãƒãƒ³ãƒ‰ãƒ© =====
export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ message: 'Method not allowed' })
  try {
    const { message, currentStep = 0, isNumberConfirmed = false, sessionId = 'default' } = req.body
    const session = getSession(sessionId)

    // Step0: â‘ ç•ªå·â†’â‘¡è·ç¨®â†’â‘¢å‹¤å‹™å…ˆ
    if (currentStep === 0) {
      if (!isNumberConfirmed) {
        const num = (message.match(/\d+/) || [null])[0]
        if (num) {
          session.candidateNumber = num
          return respond(res, `æ±‚è·è€…ç•ªå·ï¼š${num} ã­ï¼\næ¬¡ã¯ â‘¡ã€Œä»Šã®è·ç¨®ã€ã‚’æ•™ãˆã¦ï¼`, 0, { candidateNumber: num, isNumberConfirmed: true })
        }
        return respond(res, 'OKã€ã¾ãšã¯ â‘ æ±‚è·è€…ç•ªå· ã ã‘æ•™ãˆã¦ï¼', 0)
      }
      if (!session.qualification) {
        session.qualification = message.trim()
        return respond(res, 'ãƒŠã‚¤ã‚¹ã€‚æ¬¡ã¯ â‘¢ã€Œã„ã¾åƒã„ã¦ã‚‹å ´æ‰€ã€ï¼ˆæ–½è¨­åã‚„æ¥­æ…‹ï¼‰ã‚’æ•™ãˆã¦ï¼', 0)
      }
      if (!session.workplace) {
        session.workplace = message.trim()
        return respond(res,
          'OKã€ã“ã“ã‹ã‚‰æœ¬é¡Œã„ãã‚ˆã€‚\nã¾ãšã¯ã€Œè»¢è·ç†ç”±ã€ã€‚ãã£ã‹ã‘ã£ã¦ã©ã‚“ãªã“ã¨ã ã£ãŸï¼Ÿ\nã—ã‚“ã©ã‹ã£ãŸã“ã¨ã€ã“ã‚Œã¯ç„¡ç†ã ã¨æ€ã£ãŸã“ã¨ã€æŒ‘æˆ¦ã—ãŸã„ã“ã¨ã€ä½•ã§ã‚‚OKï¼',
          1)
      }
      return respond(res,'ã“ã“ã‹ã‚‰æœ¬é¡Œã„ãã‚ˆã€‚ã¾ãšã¯ã€Œè»¢è·ç†ç”±ã€ã‚’æ•™ãˆã¦ï¼',1)
    }

    // Step1: è»¢è·ç†ç”±ï¼ˆã‚«ãƒ†ã‚´ãƒªæ¤œå‡ºâ†’å€™è£œ2-3ä»¶ or å…±æ„Ÿã—ã¦æ¬¡ã¸ï¼‰
    if (currentStep === 1) {
      if (session.awaitingSelection) {
        const num = (message.match(/[1-3ï¼‘-ï¼“]/) || [null])[0]
        let chosen = null
        if (num) {
          const idx = parseInt(num.replace('ï¼‘','1').replace('ï¼’','2').replace('ï¼“','3')) - 1
          chosen = session.selectionOptions[idx]
        } else {
          chosen = session.selectionOptions.find(o => message.includes(o)) || null
        }
        if (chosen) {
          session.transferReason = chosen
          session.awaitingSelection = false
          session.selectionOptions = []
          return respond(res, 'äº†è§£ã€‚\nã˜ã‚ƒã‚æ¬¡ï¼çµ¶å¯¾ã«ã‚†ãšã‚Œãªã„æ¡ä»¶ã‚’æ•™ãˆã¦ã€‚', 2)
        }
        const list = session.selectionOptions.map((o,i)=>`${i+1}. ${o}`).join('\n')
        return respond(res, `ç•ªå·ã§é¸ã‚“ã§ã­ï¼ˆè‡ªç”±å…¥åŠ›ã§ã‚‚OKï¼‰ã€‚\n\n${list}`, 1)
      }

      const det = detectCategory(message)
      if (det) session.currentCategory = det.cat
      const header = det
        ? `ã‚«ãƒ†ã‚´ãƒªï¼š${det.cat}\næ‹¾ãˆãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š${(det.keywords||[]).slice(0,5).join('ãƒ»') || 'â€”'}\n`
        : 'ã‚«ãƒ†ã‚´ãƒªï¼šæœªåˆ†é¡\næ‹¾ãˆãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼šâ€”\n'
      const noCandidate = det && !(transferReasonFlow[det.cat]?.internal_options || []).length

      if (noCandidate) {
        session.transferReason = message.trim()
        return respond(res, `ãªã‚‹ã»ã©ã€ãã®æ°—æŒã¡ã‚ˆãã‚ã‹ã‚‹ï¼å¤§äº‹ãªè»¢è·ã®ãã£ã‹ã‘ã ã­â—\n${header}ã˜ã‚ƒã‚æ¬¡ï¼çµ¶å¯¾ã«ã‚†ãšã‚Œãªã„æ¡ä»¶ã‚’æ•™ãˆã¦ã€‚`, 2)
      }

      const options = pickOptions(session.currentCategory)
      if (options.length) {
        session.selectionOptions = options
        session.awaitingSelection = true
        const list = options.map((o,i)=>`${i+1}. ${o}`).join('\n')
        return respond(res, `${header}è¿‘ã„ã®ã¯ã“ã®ã‚ãŸã‚Šã€‚ç•ªå·ã§é¸ã‚“ã§ã­ï¼ˆè‡ªç”±å…¥åŠ›ã§ã‚‚OKï¼‰ã€‚\n\n${list}`, 1)
      }

      session.transferReason = message.trim()
      return respond(res, `${header}OKã€‚ã˜ã‚ƒã‚æ¬¡ï¼çµ¶å¯¾ã«ã‚†ãšã‚Œãªã„æ¡ä»¶ã‚’æ•™ãˆã¦ã€‚`, 2)
    }

    // Step2: Must
    if (currentStep === 2) {
      const found = matchDict(message)
      if (found.length) session.mustConditions = Array.from(new Set([...(session.mustConditions||[]), ...found]))
      return respond(res, 'äº†è§£ã€‚æ¬¡ã€çµ¶å¯¾NGã‚’æ•™ãˆã¦ã€‚\né¿ã‘ãŸã„è·å ´ã‚¿ã‚¤ãƒ—ã‚„åƒãæ–¹ãŒã‚ã‚Œã°æŒ™ã’ã¦ã­ã€‚', 3)
    }

    // Step3: NG
    if (currentStep === 3) {
      const found = matchDict(message)
      if (found.length) session.ngConditions = Array.from(new Set([...(session.ngConditions||[]), ...found]))
      return respond(res, 'è³ªå•ã¯æ®‹ã‚Š2ã¤ï¼ã“ã‚Œã¾ã§ã‚„ã£ã¦ããŸã“ã¨ã‚’è‡ªç„¶æ–‡ã§æ•™ãˆã¦ã€‚ç®‡æ¡æ›¸ãã§ã‚‚OKã€‚', 4)
    }

    // Step4: ã“ã‚Œã¾ã§
    if (currentStep === 4) {
      session.canDo = message.trim()
      return respond(res, 'ã“ã‚ŒãŒæœ€å¾Œã®è³ªå•ğŸ‘ ã“ã‚Œã‹ã‚‰æŒ‘æˆ¦ã—ãŸã„ã“ã¨ãƒ»ã‚„ã£ã¦ã¿ãŸã„ã“ã¨ã‚’æ•™ãˆã¦ã€‚', 5)
    }

    // Step5: ã“ã‚Œã‹ã‚‰ + ç°¡æ˜“è¦ç´„ï¼ˆæ•´å½¢ã®ã¿GPTå¯ï¼‰
    if (currentStep === 5) {
      session.willDo = message.trim()
      const plain =
`ä»Šæ—¥ã¯ãŸãã•ã‚“è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼
ã“ã®å†…å®¹ã‚’ã‚‚ã¨ã«ã€æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ”ãƒƒã‚¿ãƒªãªææ¡ˆã‚’æº–å‚™ã™ã‚‹ã­ã€‚

â–¼é¢è«‡å‰å…±æœ‰ãƒ¡ãƒ¢
- è»¢è·ç†ç”±: ${session.transferReason || 'æœªå…¥åŠ›'}
- çµ¶å¯¾æ¡ä»¶: ${(session.mustConditions||[]).join('ã€') || 'æœªå…¥åŠ›'}
- çµ¶å¯¾NG: ${(session.ngConditions||[]).join('ã€') || 'æœªå…¥åŠ›'}
- ã“ã‚Œã¾ã§: ${session.canDo || 'æœªå…¥åŠ›'}
- ã“ã‚Œã‹ã‚‰: ${session.willDo || 'æœªå…¥åŠ›'}`
      return respond(res, plain, 6, { sessionData: session })
    }

    return respond(res, 'æƒ³å®šå¤–ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ã­ã€‚', 0)
  } catch (e) {
    console.error('chat api error', e)
    return res.status(500).json({ message: 'Internal server error', error: e.message })
  }
}
