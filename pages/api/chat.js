// pages/api/chat.js
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// è»¢è·ç†ç”±åˆ†é¡ãƒ‡ãƒ¼ã‚¿ï¼ˆå…ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Œå…¨æº–æ‹ ï¼‰
const transferReasonFlow = {
  "çµŒå–¶ãƒ»çµ„ç¹”ã«é–¢ã™ã‚‹ã“ã¨": {
    "keywords": ["ç†å¿µ", "æ–¹é‡", "ä¾¡å€¤è¦³", "çµŒå–¶", "é‹å–¶", "ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ", "æ–¹å‘æ€§", "ãƒ“ã‚¸ãƒ§ãƒ³", "ãƒŸãƒƒã‚·ãƒ§ãƒ³", "è€ƒãˆæ–¹", "å§¿å‹¢", "çµŒå–¶é™£", "ãƒˆãƒƒãƒ—", "é¢¨é€šã—", "æ„è¦‹", "ç™ºè¨€", "è©•ä¾¡åˆ¶åº¦", "è©•ä¾¡", "æ˜‡çµ¦", "æ˜‡æ ¼", "å…¬å¹³", "åŸºæº–", "æ•™è‚²ä½“åˆ¶", "ç ”ä¿®", "ãƒãƒ‹ãƒ¥ã‚¢ãƒ«", "OJT", "ãƒ•ã‚©ãƒ­ãƒ¼", "æ•™è‚²", "ã‚µãƒãƒ¼ãƒˆ", "çµŒå–¶è€…", "åŒ»ç™‚è·", "ç¾å ´ç†è§£", "å£²ä¸Š", "æ•°å­—"],
    "internal_options": [
      "MVVãƒ»çµŒå–¶ç†å¿µã«å…±æ„Ÿã§ãã‚‹è·å ´ã§åƒããŸã„",
      "é¢¨é€šã—ãŒã‚ˆãæ„è¦‹ãŒè¨€ã„ã‚„ã™ã„è·å ´ã§åƒããŸã„", 
      "è©•ä¾¡åˆ¶åº¦ãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„",
      "æ•™è‚²ä½“åˆ¶ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„",
      "çµŒå–¶è€…ãŒåŒ»ç™‚è·ã®ã¨ã“ã‚ã§åƒããŸã„",
      "çµŒå–¶è€…ãŒåŒ»ç™‚è·ã§ã¯ãªã„ã¨ã“ã‚ã§åƒããŸã„"
    ]
  },
  "åƒãä»²é–“ã«é–¢ã™ã‚‹ã“ã¨": {
    "keywords": ["äººé–“é–¢ä¿‚", "è·å ´ã®é›°å›²æ°—", "ä¸Šå¸", "å…ˆè¼©", "åŒåƒš", "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯", "ã„ã˜ã‚", "ãƒ‘ãƒ¯ãƒãƒ©", "ã‚»ã‚¯ãƒãƒ©", "é™°å£", "æ´¾é–¥", "ãŠå±€", "ç†ä¸å°½", "ç›¸è«‡ã§ããªã„", "å­¤ç«‹", "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³", "ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«", "å°Šæ•¬", "æ†§ã‚Œ", "è¦‹ç¿’ã„ãŸã„", "ä¾¡å€¤è¦³", "æ¸©åº¦æ„Ÿ", "ã‚„ã‚‹æ°—", "ä¿¡é ¼", "å“æ ¼", "ä¸€è²«æ€§", "ç›®æ¨™", "æ‰‹æœ¬", "è·ç¨®", "é€£æº", "åŠ©ã‘åˆã„", "å£", "åˆ†æ–­", "å¤æ ª", "æ¨©åŠ›", "åœ§", "æ”¯é…"],
    "internal_options": [
      "äººé–“é–¢ä¿‚ã®ãƒˆãƒ©ãƒ–ãƒ«ãŒå°‘ãªã„è·å ´ã§åƒããŸã„",
      "åŒã˜ä¾¡å€¤è¦³ã‚’æŒã¤ä»²é–“ã¨åƒããŸã„", 
      "å°Šæ•¬ã§ãã‚‹ä¸Šå¸ãƒ»çµŒå–¶è€…ã¨åƒããŸã„",
      "ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ãªã‚‹ä¸Šå¸ã‚„å…ˆè¼©ãŒã»ã—ã„",
      "è·ç¨®é–¢ä¿‚ãªãä¸€ä½“æ„ŸãŒã‚ã‚‹ä»²é–“ã¨åƒããŸã„",
      "ãŠå±€ãŒã„ãªã„è·å ´ã§åƒããŸã„"
    ]
  },
  "ä»•äº‹å†…å®¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«é–¢ã™ã‚‹ã“ã¨": {
    "keywords": ["ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—", "æˆé•·", "æŒ‘æˆ¦", "ã‚„ã‚ŠãŒã„", "æ¥­å‹™å†…å®¹", "å°‚é–€æ€§", "ç ”ä¿®", "æ•™è‚²", "ã‚­ãƒ£ãƒªã‚¢", "æ˜‡é€²", "æ˜‡æ ¼", "è³‡æ ¼å–å¾—", "çµŒé¨“", "å­¦ã¹ã‚‹", "æ–°ã—ã„", "å¹…ã‚’åºƒã’ã‚‹", "çµŒé¨“", "å¼·ã¿", "æ´»ã‹ã™", "è³‡æ ¼", "å¾—æ„", "æœªçµŒé¨“", "åˆ†é‡", "æ‚£è€…", "åˆ©ç”¨è€…", "è²¢çŒ®", "å®Ÿæ„Ÿ", "æ›¸é¡", "ä»¶æ•°", "å½¹ç«‹ã¤", "ã‚ã‚ŠãŒã¨ã†", "è²¬ä»»", "å½¹è·", "æ©Ÿä¼š", "é“ç­‹", "ç™»ç”¨"],
    "internal_options": [
      "ä»Šã¾ã§ã®çµŒé¨“ã‚„è‡ªåˆ†ã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸã„",
      "æœªçµŒé¨“ã®ä»•äº‹ï¼åˆ†é‡ã«æŒ‘æˆ¦ã—ãŸã„",
      "ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸã„",
      "æ‚£è€…ãƒ»åˆ©ç”¨è€…ã¸ã®è²¢çŒ®å®Ÿæ„Ÿã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ä»•äº‹ã«æºã‚ã‚Œã‚‹",
      "æ˜‡é€²ãƒ»æ˜‡æ ¼ã®æ©Ÿä¼šãŒã‚ã‚‹"
    ]
  },
  "åŠ´åƒæ¡ä»¶ã«é–¢ã™ã‚‹ã“ã¨": {
    "keywords": ["æ®‹æ¥­", "å¤œå‹¤", "ä¼‘æ—¥", "æœ‰çµ¦", "åƒãæ–¹", "æ™‚é–“", "ã‚·ãƒ•ãƒˆ", "å‹¤å‹™æ™‚é–“", "é€£å‹¤", "ä¼‘æ†©", "ã‚ªãƒ³ã‚³ãƒ¼ãƒ«", "å‘¼ã³å‡ºã—", "å‰¯æ¥­", "å…¼æ¥­", "ç¤¾ä¼šä¿é™º", "ä¿é™º", "å¥ä¿", "åšç”Ÿå¹´é‡‘", "è¨ºç™‚æ™‚é–“", "è‡ªå·±ç ”é‘½", "å‹‰å¼·", "å­¦ç¿’", "ç ”ä¿®æ™‚é–“", "ç›´è¡Œç›´å¸°", "äº‹å‹™æ‰€", "ç«‹ã¡å¯„ã‚Š", "æœç¤¼", "æ—¥å ±", "å®šæ™‚", "ã‚µãƒ¼ãƒ“ã‚¹æ®‹æ¥­", "ç”³è«‹åˆ¶", "äººå“¡é…ç½®", "å¸Œæœ›æ—¥", "åŠä¼‘", "æ™‚é–“æœ‰ä¼‘", "æ‰¿èª", "å°±æ¥­è¦å‰‡", "å…¼æ¥­", "è¨±å¯", "å¥åº·ä¿é™º", "é›‡ç”¨ä¿é™º", "åŠ´ç½", "æ‰‹ç¶šã", "å§‹æ¥­å‰", "æº–å‚™", "æ¸…æƒ", "æ‰“åˆ»"],
    "internal_options": [
      "ç›´è¡Œç›´å¸°ãŒã§ãã‚‹è·å ´ã§åƒããŸã„",
      "æ®‹æ¥­ã®ãªã„è·å ´ã§åƒããŸã„", 
      "å¸Œæœ›é€šã‚Šã«æœ‰çµ¦ãŒå–å¾—ã§ãã‚‹è·å ´ã§åƒããŸã„",
      "å‰¯æ¥­OKãªè·å ´ã§åƒããŸã„",
      "ç¤¾ä¼šä¿é™ºã‚’å®Œå‚™ã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„",
      "è¨ºç™‚æ™‚é–“å†…ã§è‡ªå·±ç ”é‘½ã§ãã‚‹è·å ´ã§åƒããŸã„",
      "å‰æ®‹æ¥­ã®ãªã„è·å ´ã§åƒããŸã„"
    ]
  },
  "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«é–¢ã™ã‚‹ã“ã¨": {
    "keywords": ["å®¶åº­", "è‚²å…", "å­è‚²ã¦", "ä¸¡ç«‹", "ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸", "å­ã©ã‚‚", "å®¶æ—", "ä»‹è­·", "ä¿è‚²åœ’", "é€è¿", "å­¦æ ¡è¡Œäº‹", "é€šé™¢", "ç™ºç†±", "ä¸­æŠœã‘", "æ™‚çŸ­", "ã‚¤ãƒ™ãƒ³ãƒˆ", "é£²ã¿ä¼š", "BBQ", "ç¤¾å“¡æ—…è¡Œ", "æ—©æœæ¸…æƒ", "å¼·åˆ¶", "æ¥­å‹™å¤–", "å°±æ¥­å¾Œ", "ä¼‘æ—¥", "ã‚ªãƒ•", "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ", "ä»²è‰¯ã", "äº¤æµ", "ã”ã¯ã‚“", "è¶£å‘³"],
    "internal_options": [
      "å®¶åº­ã¨ã®ä¸¡ç«‹ã«ç†è§£ã®ã‚ã‚‹è·å ´ã§åƒããŸã„",
      "å‹¤å‹™æ™‚é–“å¤–ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„è·å ´ã§åƒããŸã„", 
      "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§ã‚‚ä»²è‰¯ãã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„"
    ]
  },
  "è·å ´ç’°å¢ƒãƒ»è¨­å‚™": {
    "keywords": ["è¨­å‚™", "ç’°å¢ƒ", "æ–½è¨­", "å™¨æ¢°", "æ©Ÿå™¨", "ã‚·ã‚¹ãƒ†ãƒ ", "IT", "ãƒ‡ã‚¸ã‚¿ãƒ«", "å¤ã„", "æ–°ã—ã„", "æœ€æ–°", "è¨­ç½®", "å°å…¥", "æ•´å‚™"],
    "internal_options": []
  },
  "è·å ´ã®å®‰å®šæ€§": {
    "keywords": ["å®‰å®š", "å°†æ¥æ€§", "çµŒå–¶çŠ¶æ³", "å€’ç”£", "ãƒªã‚¹ãƒˆãƒ©", "ä¸å®‰", "ç¶™ç¶š", "æŒç¶š", "æˆé•·", "ç™ºå±•", "å°†æ¥", "å…ˆè¡Œã"],
    "internal_options": []
  },
  "çµ¦ä¸ãƒ»å¾…é‡": {
    "keywords": ["çµ¦æ–™", "çµ¦ä¸", "å¹´å", "æœˆå", "æ‰‹å–ã‚Š", "è³ä¸", "ãƒœãƒ¼ãƒŠã‚¹", "æ˜‡çµ¦", "æ‰‹å½“", "å¾…é‡", "ç¦åˆ©åšç”Ÿ", "å®‰ã„", "ä½ã„", "ä¸ŠãŒã‚‰ãªã„", "ç”Ÿæ´»ã§ããªã„", "ãŠé‡‘"],
    "internal_options": []
  }
};

// mustWantè¾æ›¸ï¼ˆæ­£ç¢ºãªtag_labelï¼‰
const mustWantItems = [
  "æ€¥æ€§æœŸç—…æ£Ÿ", "å›å¾©æœŸç—…æ£Ÿ", "æ…¢æ€§æœŸãƒ»ç™‚é¤Šå‹ç—…é™¢", "ä¸€èˆ¬ç—…é™¢", "åœ°åŸŸåŒ…æ‹¬ã‚±ã‚¢ç—…æ£Ÿ", "ç™‚é¤Šç—…æ£Ÿ", 
  "ç·©å’Œã‚±ã‚¢ç—…æ£Ÿï¼ˆãƒ›ã‚¹ãƒ”ã‚¹ï¼‰", "ã‚¯ãƒªãƒ‹ãƒƒã‚¯", "ç²¾ç¥ç§‘ç—…é™¢", "è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", 
  "ç²¾ç¥ç§‘ç‰¹åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "æ©Ÿèƒ½å¼·åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "è¨ªå•ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", 
  "è¨ªå•æ „é¤ŠæŒ‡å°", "é€šæ‰€ä»‹è­·ï¼ˆãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰", "èªçŸ¥ç—‡å¯¾å¿œå‹é€šæ‰€ä»‹è­·ï¼ˆèªçŸ¥ç—‡å°‚é–€ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰", 
  "åœ°åŸŸå¯†ç€å‹é€šæ‰€ä»‹è­·ï¼ˆå®šå“¡18åä»¥ä¸‹ï¼‰", "é€šæ‰€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ã‚¤ã‚±ã‚¢ï¼‰", "è¨ªå•ä»‹è­·", 
  "å®šæœŸå·¡å›ãƒ»éšæ™‚å¯¾å¿œå‹è¨ªå•ä»‹è­·çœ‹è­·", "è¨ªå•å…¥æµ´", "å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·", "çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·", 
  "ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ", "åœ°åŸŸå¯†ç€å‹ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ï¼ˆå®šå“¡29åä»¥ä¸‹ï¼‰", "ä»‹è­·è€äººä¿å¥æ–½è¨­", 
  "ä»‹è­·ä»˜ãæœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ", "ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼ˆçŸ­æœŸå…¥æ‰€ç”Ÿæ´»ä»‹è­·ï¼‰", "ã‚µãƒ¼ãƒ“ã‚¹ä»˜ãé«˜é½¢è€…å‘ã‘ä½å®…ï¼ˆã‚µé«˜ä½ï¼‰", 
  "ä½å®…å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ", "è»½è²»è€äººãƒ›ãƒ¼ãƒ ï¼ˆã‚±ã‚¢ãƒã‚¦ã‚¹ï¼‰", "å¥åº·å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ", "ã‚·ãƒ‹ã‚¢å‘ã‘åˆ†è­²ãƒãƒ³ã‚·ãƒ§ãƒ³", 
  "æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹", "ç”Ÿæ´»ä»‹è­·ï¼ˆéšœå®³è€…ã®æ—¥ä¸­æ´»å‹•ï¼‰", "å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹", "å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹", 
  "çŸ­æœŸå…¥æ‰€ï¼ˆéšœå®³è€…å‘ã‘ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰", "æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯", "è¨ªå•æ­¯ç§‘", "æ­¯ç§‘å£è…”å¤–ç§‘ï¼ˆç—…é™¢å†…è¨ºç™‚ç§‘ï¼‰", 
  "å¤§å­¦ç—…é™¢æ­¯ç§‘ãƒ»æ­¯å­¦éƒ¨é™„å±ç—…é™¢", "æ­¯ç§‘æŠ€å·¥æ‰€", "é™¢å†…ãƒ©ãƒœ", "ä¿è‚²åœ’", "å¹¼ç¨šåœ’", 
  "ä¼æ¥­ï¼ˆç”£æ¥­ä¿å¥ãƒ»ä¼æ¥­å†…çœ‹è­·ãªã©ï¼‰", "4é€±8ä¼‘ä»¥ä¸Š", "è‚²å…æ”¯æ´ã‚ã‚Š", "å¹´é–“ä¼‘æ—¥120æ—¥ä»¥ä¸Š", 
  "é€±1æ—¥ã‹ã‚‰OK", "é€±2æ—¥ã‹ã‚‰OK", "åœŸæ—¥ç¥ä¼‘ã¿", "å®¶åº­éƒ½åˆä¼‘OK", "æœˆ1ã‚·ãƒ•ãƒˆæå‡º", 
  "æ¯é€±ï½éš”é€±ã‚·ãƒ•ãƒˆæå‡º", "æœ‰çµ¦æ¶ˆåŒ–ç‡ã»ã¼100%", "é•·æœŸä¼‘æš‡ã‚ã‚Š", "é€±ä¼‘2æ—¥", "é€±ä¼‘3æ—¥", 
  "æ—¥å‹¤ã®ã¿å¯", "å¤œå‹¤å°‚å¾“ã‚ã‚Š", "2äº¤æ›¿åˆ¶", "3äº¤æ›¿åˆ¶", "åˆå‰ã®ã¿å‹¤å‹™", "åˆå¾Œã®ã¿å‹¤å‹™", 
  "æ®‹æ¥­ã»ã¼ãªã—", "ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ãªã—ãƒ»å…é™¤å¯", "ç·Šæ€¥è¨ªå•ãªã—", "æ™‚å·®å‡ºå‹¤å°å…¥", "ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ åˆ¶åº¦ã‚ã‚Š", 
  "æ®‹æ¥­æœˆ20æ™‚é–“ä»¥å†…", "ã‚¹ã‚­ãƒæ™‚é–“å‹¤å‹™", "æ™‚çŸ­å‹¤å‹™ç›¸è«‡å¯", "é§…è¿‘ï¼ˆ5åˆ†ä»¥å†…ï¼‰", "è»Šé€šå‹¤å¯", 
  "ãƒã‚¤ã‚¯é€šå‹¤å¯", "è‡ªè»¢è»Šé€šå‹¤å¯", "é§è»Šå ´å®Œå‚™", "ç›´è¡Œç›´å¸°OK", "å¹´å300ä¸‡ä»¥ä¸Š", "å¹´å350ä¸‡ä»¥ä¸Š", 
  "å¹´å400ä¸‡ä»¥ä¸Š", "å¹´å450ä¸‡ä»¥ä¸Š", "å¹´å500ä¸‡ä»¥ä¸Š", "å¹´å550ä¸‡ä»¥ä¸Š", "å¹´å600ä¸‡ä»¥ä¸Š", 
  "å¹´å650ä¸‡ä»¥ä¸Š", "å¹´å700ä¸‡ä»¥ä¸Š", "è³ä¸ã‚ã‚Š", "é€€è·é‡‘ã‚ã‚Š", "å¯®ã‚ã‚Šãƒ»ç¤¾å®…ã‚ã‚Š", 
  "è¨—å…æ‰€ãƒ»ä¿è‚²æ”¯æ´ã‚ã‚Š", "ç¤¾ä¼šä¿é™ºå®Œå‚™", "äº¤é€šè²»æ”¯çµ¦", "æ‰¶é¤Šæ§é™¤å†…è€ƒæ…®", "å¾©è·æ”¯æ´", 
  "ä½å®…æ‰‹å½“", "å‰¯æ¥­OK", "æ—¥ãƒ»ç¥æ—¥çµ¦ä¸UP", "å¼•è¶Šã—æ‰‹å½“", "ç·Šæ€¥è¨ªå•æ™‚ã®æ‰‹å½“ãƒ»ä»£ä¼‘ã‚ã‚Š", 
  "ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè²¸ä¸ã‚ã‚Š", "é›»å‹•ã‚¢ã‚·ã‚¹ãƒˆè‡ªè»¢è»Šãƒ»ãƒã‚¤ã‚¯ãƒ»è»Šè²¸ä¸", "ç¤¾å‰²ã‚ã‚Š", 
  "ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆç›¸è«‡çª“å£ã‚ã‚Š", "ç ”ä¿®åˆ¶åº¦ã‚ã‚Š", "è³‡æ ¼å–å¾—æ”¯æ´ã‚ã‚Š", "ã‚»ãƒŸãƒŠãƒ¼å‚åŠ è²»è£œåŠ©ã‚ã‚Š", 
  "ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Œå‚™", "å‹•ç”»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š", "è©•ä¾¡åˆ¶åº¦ã‚ã‚Š", "ãƒ¡ãƒ³ã‚¿ãƒ¼åˆ¶åº¦ã‚ã‚Š", "ç‹¬ç«‹ãƒ»é–‹æ¥­æ”¯æ´ã‚ã‚Š", 
  "é™¢é•·ãƒ»åˆ†é™¢é•·å€™è£œ", "æ‹…å½“åˆ¶"
];

// å…±æ„Ÿã‚»ãƒªãƒ•ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
const empathyResponses = {
  "çµŒå–¶ãƒ»çµ„ç¹”ã«é–¢ã™ã‚‹ã“ã¨": [
    "çµŒå–¶æ–¹é‡ã£ã¦è·å ´é¸ã³ã§é‡è¦ã ã‚ˆã­ï¼",
    "çµ„ç¹”ã®ä½“åˆ¶ã¯åƒãã‚„ã™ã•ã«ç›´çµã™ã‚‹ã‚‚ã‚“ã­ï¼",
    "è©•ä¾¡åˆ¶åº¦ãŒã—ã£ã‹ã‚Šã—ã¦ãªã„ã¨ä¸å®‰ã«ãªã‚‹ã‚ˆã­ï¼"
  ],
  "åƒãä»²é–“ã«é–¢ã™ã‚‹ã“ã¨": [
    "äººé–“é–¢ä¿‚ã£ã¦æœ¬å½“ã«å¤§äº‹ã ã‚ˆã­ï¼",
    "è·å ´ã®äººé–“é–¢ä¿‚ã§ã—ã‚“ã©ã„æ€ã„ã—ã¦ã‚‹ã‚“ã ã­ï¼",
    "æ¯æ—¥é¡”ã‚’åˆã‚ã›ã‚‹äººãŸã¡ã ã‹ã‚‰é‡è¦ã ã‚ˆã­ï¼"
  ],
  "ä»•äº‹å†…å®¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«é–¢ã™ã‚‹ã“ã¨": [
    "ã‚„ã‚ŠãŒã„ã£ã¦ä»•äº‹ã‚’ç¶šã‘ã‚‹ä¸Šã§å¤§åˆ‡ã ã‚‚ã‚“ã­ï¼",
    "ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—ã§ããªã„ã¨å°†æ¥ãŒä¸å®‰ã ã‚ˆã­ï¼",
    "è‡ªåˆ†ã®æˆé•·ã‚’æ„Ÿã˜ã‚‰ã‚Œãªã„ä»•äº‹ã¯è¾›ã„ã‚ˆã­ï¼"
  ],
  "åŠ´åƒæ¡ä»¶ã«é–¢ã™ã‚‹ã“ã¨": [
    "åƒãæ–¹ã®æ¡ä»¶ã¯æœ¬å½“ã«é‡è¦ã ã‚‚ã‚“ã­ï¼",
    "ãã‚Œã¯ä½“èª¿ã«ã‚‚å½±éŸ¿ã™ã‚‹ã‹ã‚‰å¤§å¤‰ã ã­ï¼",
    "åŠ´åƒç’°å¢ƒãŒæ‚ªã„ã¨ç¶šã‘ã‚‹ã®ãŒè¾›ã„ã‚ˆã­ï¼"
  ],
  "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«é–¢ã™ã‚‹ã“ã¨": [
    "å®¶åº­ã¨ã®ä¸¡ç«‹ã£ã¦æœ¬å½“ã«å¤§å¤‰ã ã‚ˆã­ï¼",
    "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã®æ™‚é–“ã‚‚å¤§åˆ‡ã«ã—ãŸã„ã‚‚ã‚“ã­ï¼",
    "ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹ã¯é‡è¦ã ã‚ˆã­ï¼"
  ],
  "è·å ´ç’°å¢ƒãƒ»è¨­å‚™": [
    "åƒãç’°å¢ƒã£ã¦ä½œæ¥­åŠ¹ç‡ã«ã‚‚å½±éŸ¿ã™ã‚‹ã‚‚ã‚“ã­ï¼",
    "å¤ã„è¨­å‚™ã ã¨ä»•äº‹ãŒã‚„ã‚Šã«ãã„ã‚ˆã­ï¼"
  ],
  "è·å ´ã®å®‰å®šæ€§": [
    "è·å ´ã®å°†æ¥æ€§ã¯æ°—ã«ãªã‚‹ã‚ˆã­ï¼",
    "çµŒå–¶ãŒä¸å®‰å®šã ã¨å¿ƒé…ã«ãªã‚‹ã‚‚ã‚“ã­ï¼"
  ],
  "çµ¦ä¸ãƒ»å¾…é‡": [
    "ãŠçµ¦æ–™ã®ã“ã¨ã¯ç”Ÿæ´»ã«ç›´çµã™ã‚‹ã‚‚ã‚“ã­ï¼",
    "å¾…é‡é¢ã§ã®ä¸æº€ãŒã‚ã‚‹ã¨ç¶šã‘ã‚‹ã®ãŒè¾›ã„ã‚ˆã­ï¼"
  ]
};

// æ·±æ˜ã‚Šè³ªå•ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰
const deepDrillQuestions = {
  "çµŒå–¶ãƒ»çµ„ç¹”ã«é–¢ã™ã‚‹ã“ã¨": [
    ["çµŒå–¶æ–¹é‡ã§ç‰¹ã«åˆã‚ãªã„ã¨æ„Ÿã˜ã‚‹éƒ¨åˆ†ã¯ï¼Ÿ", "çµ„ç¹”ã®ä½“åˆ¶ã§å›°ã£ã¦ã‚‹ã“ã¨ãŒã‚ã‚‹ï¼Ÿ", "è©•ä¾¡ã‚„æ•™è‚²é¢ã§ä¸æº€ãŒã‚ã‚‹ï¼Ÿ"],
    ["ãã‚Œã£ã¦æ”¹å–„ã•ã‚Œãã†ã«ãªã„æ„Ÿã˜ï¼Ÿ", "ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚‚åŒã˜ã‚ˆã†ã«æ„Ÿã˜ã¦ã‚‹ï¼Ÿ", "å…·ä½“çš„ã«ã¯ã©ã‚“ãªå ´é¢ã§ä¸€ç•ªæ„Ÿã˜ã‚‹ï¼Ÿ"]
  ],
  "åƒãä»²é–“ã«é–¢ã™ã‚‹ã“ã¨": [
    ["å…·ä½“çš„ã«ã¯ã©ã‚“ãªäººé–“é–¢ä¿‚ã§å›°ã£ã¦ã‚‹ã®ï¼Ÿ", "ä¸Šå¸ã‚„å…ˆè¼©ã¨ã®é–¢ä¿‚ï¼Ÿãã‚Œã¨ã‚‚åŒåƒšã¨ã®é–¢ä¿‚ï¼Ÿ", "è·å ´ã®é›°å›²æ°—ãŒæ‚ªã„ã£ã¦ã“ã¨ï¼Ÿ"],
    ["ãã‚Œã£ã¦æ¯æ—¥ç¶šã„ã¦ã‚‹æ„Ÿã˜ï¼Ÿ", "ç›¸è«‡ã§ãã‚‹äººã¯ã„ãªã„çŠ¶æ³ï¼Ÿ", "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®é¢ã§ã‚‚å›°ã£ã¦ã‚‹ã“ã¨ã‚ã‚‹ï¼Ÿ"]
  ],
  "ä»•äº‹å†…å®¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«é–¢ã™ã‚‹ã“ã¨": [
    ["ä»Šã®ä»•äº‹å†…å®¹ã§ç‰©è¶³ã‚Šãªã•ã‚’æ„Ÿã˜ã¦ã‚‹ï¼Ÿ", "ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—ã®æ©Ÿä¼šãŒãªã„ï¼Ÿ", "ã‚„ã‚ŠãŒã„ã‚’æ„Ÿã˜ã‚‰ã‚Œãªã„ï¼Ÿ"],
    ["ã©ã‚“ãªä»•äº‹ã ã£ãŸã‚‰ã‚„ã‚ŠãŒã„ã‚’æ„Ÿã˜ã‚‰ã‚Œãã†ï¼Ÿ", "ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã®æ©Ÿä¼šãŒæ¬²ã—ã„ï¼Ÿ", "ã‚‚ã£ã¨è²¬ä»»ã®ã‚ã‚‹ä»•äº‹ã‚’ã—ãŸã„ï¼Ÿ"]
  ],
  "åŠ´åƒæ¡ä»¶ã«é–¢ã™ã‚‹ã“ã¨": [
    ["å…·ä½“çš„ã«ã¯ã©ã®è¾ºã‚ŠãŒä¸€ç•ªãã¤ã„ï¼Ÿ", "æ™‚é–“çš„ãªã“ã¨ï¼Ÿãã‚Œã¨ã‚‚ä¼‘ã¿ã®å–ã‚Šã¥ã‚‰ã•ï¼Ÿ", "å‹¤å‹™æ¡ä»¶ã§ç‰¹ã«å›°ã£ã¦ã‚‹ã“ã¨ã¯ï¼Ÿ"],
    ["ãã‚ŒãŒãšã£ã¨ç¶šã„ã¦ã‚‹çŠ¶æ³ï¼Ÿ", "æ”¹å–„ã®è¦‹è¾¼ã¿ã¯ãªã•ãã†ï¼Ÿ", "ä»–ã«ã‚‚åŠ´åƒæ¡ä»¶ã§å›°ã£ã¦ã‚‹ã“ã¨ã‚ã‚‹ï¼Ÿ"]
  ],
  "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«é–¢ã™ã‚‹ã“ã¨": [
    ["å®¶åº­ã¨ã®ä¸¡ç«‹ã§å›°ã£ã¦ã‚‹ã“ã¨ãŒã‚ã‚‹ï¼Ÿ", "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã®æ™‚é–“ãŒå–ã‚Œãªã„ï¼Ÿ", "è·å ´ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒè² æ‹…ï¼Ÿ"],
    ["ãã‚Œã£ã¦æ”¹å–„ã®ä½™åœ°ã¯ãªã•ãã†ï¼Ÿ", "ä»–ã«ã‚‚ä¸¡ç«‹ã§å›°ã£ã¦ã‚‹ã“ã¨ã‚ã‚‹ï¼Ÿ", "ç†æƒ³çš„ãªåƒãæ–¹ã¯ã©ã‚“ãªæ„Ÿã˜ï¼Ÿ"]
  ],
  "è·å ´ç’°å¢ƒãƒ»è¨­å‚™": [
    ["ã©ã‚“ãªè¨­å‚™ã‚„ç’°å¢ƒã§å›°ã£ã¦ã‚‹ï¼Ÿ", "å¤ã„æ©Ÿå™¨ã§ä½œæ¥­åŠ¹ç‡ãŒæ‚ªã„ï¼Ÿ", "ITç’°å¢ƒãŒæ•´ã£ã¦ã„ãªã„ï¼Ÿ"],
    ["ãã‚Œã£ã¦æ¥­å‹™ã«æ”¯éšœãŒå‡ºã¦ã‚‹ï¼Ÿ", "æ”¹å–„ã®è¦æœ›ã¯å‡ºã—ãŸã“ã¨ã‚ã‚‹ï¼Ÿ", "ä»–ã«ã‚‚è¨­å‚™é¢ã§å›°ã‚‹ã“ã¨ã‚ã‚‹ï¼Ÿ"]
  ],
  "è·å ´ã®å®‰å®šæ€§": [
    ["çµŒå–¶çŠ¶æ³ã§ä¸å®‰ã«æ„Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚‹ï¼Ÿ", "å°†æ¥æ€§ã«ç–‘å•ã‚’æ„Ÿã˜ã¦ã‚‹ï¼Ÿ", "è·å ´ã®å®‰å®šæ€§ãŒå¿ƒé…ï¼Ÿ"],
    ["ãã‚Œã£ã¦å…·ä½“çš„ã«ã¯ã©ã‚“ãªã“ã¨ã§æ„Ÿã˜ã‚‹ï¼Ÿ", "ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚‚åŒã˜ã‚ˆã†ã«ä¸å®‰ãŒã£ã¦ã‚‹ï¼Ÿ", "æ”¹å–„ã•ã‚Œã‚‹è¦‹è¾¼ã¿ã¯ãªã•ãã†ï¼Ÿ"]
  ],
  "çµ¦ä¸ãƒ»å¾…é‡": [
    ["çµ¦ä¸é¢ã§ç‰¹ã«å›°ã£ã¦ã‚‹ã“ã¨ã¯ï¼Ÿ", "æ˜‡çµ¦ã®è¦‹è¾¼ã¿ãŒãªã„ï¼Ÿ", "ç¦åˆ©åšç”ŸãŒå……å®Ÿã—ã¦ãªã„ï¼Ÿ"],
    ["ãã‚Œã£ã¦ç”Ÿæ´»ã«æ”¯éšœãŒå‡ºã‚‹ãƒ¬ãƒ™ãƒ«ï¼Ÿ", "ä»–ã¨æ¯”è¼ƒã—ã¦ä½ã„ã¨æ„Ÿã˜ã‚‹ï¼Ÿ", "æ”¹å–„ã®äº¤æ¸‰ã¯ã—ãŸã“ã¨ã‚ã‚‹ï¼Ÿ"]
  ]
};

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†
const sessions = new Map();

function getSession(sessionId) {
  if (!sessions.has(sessionId)) {
    sessions.set(sessionId, {
      candidateNumber: '',
      qualification: '',
      workplace: '',
      transferReason: '',
      transferReasonRaw: '',
      mustConditions: [],
      wantConditions: [],
      canDo: '',
      willDo: '',
      deepDrillCount: 0,
      currentCategory: null,
      awaitingSelection: false,
      selectionOptions: [],
      currentStep2Processing: false,
      currentStep3Processing: false
    });
  }
  return sessions.get(sessionId);
}

// ãƒ©ãƒ³ãƒ€ãƒ é¸æŠãƒ˜ãƒ«ãƒ‘ãƒ¼
function getRandomFromArray(array, count = 1) {
  const shuffled = array.sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ message: 'Method not allowed' });
  }

  try {
    const { 
      message, 
      conversationHistory = [], 
      currentStep = 0, 
      candidateNumber = '', 
      isNumberConfirmed = false, 
      sessionId = 'default'
    } = req.body;

    const session = getSession(sessionId);

    // Step0: åŸºæœ¬æƒ…å ±åé›†ï¼ˆç•ªå·â†’è·ç¨®â†’å‹¤å‹™å…ˆã®é †ï¼‰
    if (currentStep === 0) {
      // Step0-1: æ±‚è·è€…ç•ªå·åé›†
      if (!session.candidateNumber) {
        const numberMatch = message.match(/\d+/);
        if (numberMatch) {
          const extractedNumber = numberMatch[0];
          
          // 5æ¡ä»¥ä¸Šãƒã‚§ãƒƒã‚¯
          if (extractedNumber.length < 5) {
            return res.json({
              response: `ç•ªå·ãŒé•ã†ã¿ãŸã„...ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ã‚‚ã‚‰ãˆã‚‹ï¼Ÿ
ç™»éŒ²æ™‚ã®LINEã«æ›¸ã„ã¦ã‚ã‚‹ã‚ˆï¼`,
              step: 0
            });
          }
          
          session.candidateNumber = extractedNumber;
          return res.json({
            response: `æ±‚è·è€…ç•ªå·ï¼š${extractedNumber} ã ã­ï¼
æ¬¡ã¯ â‘¡ã€Œä»Šã®è·ç¨®ã€ã‚’æ•™ãˆã¦ï¼`,
            step: 0,
            candidateNumber: extractedNumber
          });
        } else {
          return res.json({
            response: `ã“ã‚“ã«ã¡ã¯ï¼
æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®é¢è«‡ãŒã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚€ã‚ˆã†ã«ã€HOAPã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å°‘ã—ã ã‘è©±ã‚’èã‹ã›ã¦ã­ã€‚

ã„ãã¤ã‹è³ªå•ã‚’ã—ã¦ã„ãã­ã€‚
æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®é¢è«‡ã§ã—ã£ã‹ã‚Šãƒ’ã‚¢ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã‚‰ã€ä»Šæ—¥ã¯è‡ªåˆ†ã®è»¢è·ã«ã¤ã„ã¦æ”¹ã‚ã¦æ•´ç†ã™ã‚‹æ„Ÿã˜ã§ã€æ°—æ¥½ã«è©±ã—ã¦ã­ï¼

ã¾ãš3ã¤æ•™ãˆã¦ï¼
â‘ æ±‚è·è€…ç•ªå·â‘¡ä»Šã®è·ç¨®â‘¢ä»Šã©ã“ã§åƒã„ã¦ã‚‹ï¼Ÿ

ã¾ãšã¯â‘ æ±‚è·è€…ç•ªå·ã‚’æ•™ãˆã¦ï¼ï¼ˆç™»éŒ²æ™‚ã®LINEã§é€ã£ã¦ã‚‹ã‚ˆï¼ï¼‰`,
            step: 0
          });
        }
      }
      
      // Step0-2: è·ç¨®åé›†
      else if (!session.qualification) {
        session.qualification = message;
        return res.json({
          response: `OKï¼æ¬¡ã¯ â‘¢ã€Œã„ã¾åƒã„ã¦ã‚‹å ´æ‰€ã€ï¼ˆæ–½è¨­åã‚„æ¥­æ…‹ï¼‰ã‚’æ•™ãˆã¦ï¼`,
          step: 0,
          qualification: message
        });
      }
      
      // Step0-3: å‹¤å‹™å…ˆåé›†â†’Step1ã¸
      else {
        session.workplace = message;
        return res.json({
          response: `ãªã‚‹ã»ã©ã€ã‚ã‚ŠãŒã¨ã†ï¼
ã“ã“ã‹ã‚‰æœ¬é¡Œã„ãã‚ˆã€‚

ã¯ã˜ã‚ã«ã€ä»Šå›ã®è»¢è·ç†ç”±ã‚’æ•™ãˆã¦ã»ã—ã„ãªã€‚ãã£ã‹ã‘ã£ã¦ã©ã‚“ãªã“ã¨ã ã£ãŸï¼Ÿ
ã—ã‚“ã©ã„ã¨æ€ã£ãŸã“ã¨ã€ã“ã‚Œã¯ã‚‚ã†ç„¡ç†ã£ã¦æ€ã£ãŸã“ã¨ã€é€†ã«ã“ã†ã„ã†ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã„ï¼ã£ã¦æ€ã£ãŸã“ã¨ã€ä½•ã§ã‚‚OKã ã‚ˆâ—`,
          step: 1,
          workplace: message,
          basicInfo: {
            candidateNumber: session.candidateNumber,
            qualification: session.qualification,
            workplace: message
          }
        });
      }
    }

    // Step1: è»¢è·ç†ç”±ï¼ˆå®Œå…¨ç‰ˆï¼‰
    if (currentStep === 1) {
      // é¸æŠè‚¢ã¸ã®å›ç­”ãƒã‚§ãƒƒã‚¯
      if (session.awaitingSelection) {
        const selectedOption = session.selectionOptions.find(opt => 
          message.toLowerCase().includes(opt.toLowerCase().substring(0, 15)) ||
          message.includes('1') && session.selectionOptions[0] === opt ||
          message.includes('2') && session.selectionOptions[1] === opt ||
          message.includes('3') && session.selectionOptions[2] === opt
        );
        
        if (selectedOption) {
          session.transferReason = selectedOption;
          session.awaitingSelection = false;
          session.selectionOptions = [];
          
          // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸæŸ”è»Ÿãªå…±æ„Ÿ
          const categoryEmpathy = getRandomFromArray(empathyResponses[session.currentCategory] || ["ãã‚Œã¯å¤§äº‹ã ã‚ˆã­ï¼"], 1)[0];
          
          return res.json({
            response: `${categoryEmpathy}ã¤ã¾ã‚Šã€${selectedOption}ã€ã£ã¦ã“ã¨ã ã­ï¼

ã‚ã‚ŠãŒã¨ã†ï¼

ã˜ã‚ƒã‚æ¬¡ã®è³ªå•ï¼
ä»Šå›ã®è»¢è·ã§ã“ã‚Œã ã‘ã¯çµ¶å¯¾è­²ã‚Œãªã„ï¼ã¨ã„ã†ã®ã‚’æ•™ãˆã¦ï¼
ä»•äº‹å†…å®¹ã§ã‚‚ã€åˆ¶åº¦ã§ã‚‚ã€æ¡ä»¶ã§ã‚‚OKâ—

ä¾‹ãˆã°ãƒ»ãƒ»ãƒ»
ã€Œçµ¶å¯¾åœŸæ—¥ä¼‘ã¿ã˜ã‚ƒãªã„ã¨å›°ã‚‹ï¼ã€
ã€Œçµ¶å¯¾ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ã¯ã§ããªã„ï¼ã€

å¾Œã‹ã‚‰ã€ã‚ã‚‹ã¨ã„ã„ãªã€ã€ãªã„ã¨ã„ã„ãªã€ã«ã¤ã„ã¦ã‚‚èãã‹ã‚‰ã€ä»Šã¯ã€çµ¶å¯¾ï¼ã€ã¨ã„ã†ã‚‚ã®ã ã‘æ•™ãˆã¦ã­ã€‚`,
            step: 2,
            taggedData: {
              transferReason: selectedOption
            }
          });
        } else {
          return res.json({
            response: "é¸æŠè‚¢ã®ä¸­ã‹ã‚‰é¸ã‚“ã§ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿç•ªå·ã§ã‚‚ã€å†…å®¹ã§ã‚‚ã€ã©ã¡ã‚‰ã§ã‚‚OKã§ã™ï¼",
            step: 1
          });
        }
      }

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†
      const keywordMatches = {};
      Object.keys(transferReasonFlow).forEach(category => {
        const keywords = transferReasonFlow[category].keywords;
        let matchCount = 0;
        keywords.forEach(keyword => {
          if (message.toLowerCase().includes(keyword.toLowerCase())) {
            matchCount++;
          }
        });
        if (matchCount > 0) {
          keywordMatches[category] = matchCount;
        }
      });

      // æœ€å¤šãƒãƒƒãƒã‚«ãƒ†ã‚´ãƒªã‚’ç‰¹å®š
      const maxMatches = Math.max(...Object.values(keywordMatches), 0);
      const topCategories = Object.keys(keywordMatches).filter(cat => 
        keywordMatches[cat] === maxMatches
      );

      if (topCategories.length === 0) {
        // æœªãƒãƒƒãƒå‡¦ç†
        session.transferReasonRaw = message;
        return res.json({
          response: `ãªã‚‹ã»ã©ã€ãã®æ°—æŒã¡ã‚ˆãã‚ã‹ã‚‹ï¼å¤§äº‹ãªè»¢è·ã®ãã£ã‹ã‘ã ã­â—

ã‚ã‚ŠãŒã¨ã†ï¼

ã˜ã‚ƒã‚æ¬¡ã®è³ªå•ï¼
ä»Šå›ã®è»¢è·ã§ã“ã‚Œã ã‘ã¯çµ¶å¯¾è­²ã‚Œãªã„ï¼ã¨ã„ã†ã®ã‚’æ•™ãˆã¦ï¼
ä»•äº‹å†…å®¹ã§ã‚‚ã€åˆ¶åº¦ã§ã‚‚ã€æ¡ä»¶ã§ã‚‚OKâ—

ä¾‹ãˆã°ãƒ»ãƒ»ãƒ»
ã€Œçµ¶å¯¾åœŸæ—¥ä¼‘ã¿ã˜ã‚ƒãªã„ã¨å›°ã‚‹ï¼ã€
ã€Œçµ¶å¯¾ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ã¯ã§ããªã„ï¼ã€

å¾Œã‹ã‚‰ã€ã‚ã‚‹ã¨ã„ã„ãªã€ã€ãªã„ã¨ã„ã„ãªã€ã«ã¤ã„ã¦ã‚‚èãã‹ã‚‰ã€ä»Šã¯ã€çµ¶å¯¾ï¼ã€ã¨ã„ã†ã‚‚ã®ã ã‘æ•™ãˆã¦ã­ã€‚`,
          step: 2,
          taggedData: {
            transferReason: null,
            transferReasonRaw: message
          }
        });
      }

      const selectedCategory = topCategories[0];
      const categoryData = transferReasonFlow[selectedCategory];
      const options = categoryData.internal_options;

      // ç¦æ­¢ã‚«ãƒ†ã‚´ãƒªï¼ˆå€™è£œãŒç©ºï¼‰ã®å‡¦ç†
      if (options.length === 0) {
        session.transferReasonRaw = message;
        return res.json({
          response: `ãªã‚‹ã»ã©ã€ãã®æ°—æŒã¡ã‚ˆãã‚ã‹ã‚‹ï¼å¤§äº‹ãªè»¢è·ã®ãã£ã‹ã‘ã ã­â—

ã‚ã‚ŠãŒã¨ã†ï¼

ã˜ã‚ƒã‚æ¬¡ã®è³ªå•ï¼
ä»Šå›ã®è»¢è·ã§ã“ã‚Œã ã‘ã¯çµ¶å¯¾è­²ã‚Œãªã„ï¼ã¨ã„ã†ã®ã‚’æ•™ãˆã¦ï¼
ä»•äº‹å†…å®¹ã§ã‚‚ã€åˆ¶åº¦ã§ã‚‚ã€æ¡ä»¶ã§ã‚‚OKâ—

ä¾‹ãˆã°ãƒ»ãƒ»ãƒ»
ã€Œçµ¶å¯¾åœŸæ—¥ä¼‘ã¿ã˜ã‚ƒãªã„ã¨å›°ã‚‹ï¼ã€
ã€Œçµ¶å¯¾ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ã¯ã§ããªã„ï¼ã€

å¾Œã‹ã‚‰ã€ã‚ã‚‹ã¨ã„ã„ãªã€ã€ãªã„ã¨ã„ã„ãªã€ã«ã¤ã„ã¦ã‚‚èãã‹ã‚‰ã€ä»Šã¯ã€çµ¶å¯¾ï¼ã€ã¨ã„ã†ã‚‚ã®ã ã‘æ•™ãˆã¦ã­ã€‚`,
          step: 2,
          taggedData: {
            transferReason: null,
            transferReasonRaw: message
          }
        });
      }

      // æ·±æ˜ã‚Šã¾ãŸã¯å€™è£œæç¤º
      if (session.deepDrillCount < 2) {
        session.deepDrillCount++;
        session.currentCategory = selectedCategory;
        
        // ã‚«ãƒ†ã‚´ãƒªåˆ¥æ·±æ˜ã‚Šè³ªå•ã‚’å–å¾—
        const drillQuestions = deepDrillQuestions[selectedCategory] || [
          ["ãã‚Œã«ã¤ã„ã¦ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦", "å…·ä½“çš„ã«ã¯ã©ã‚“ãªï¼Ÿ"],
          ["ä»–ã«ã‚‚é–¢é€£ã™ã‚‹ã“ã¨ã¯ã‚ã‚‹ï¼Ÿ", "ãã‚Œã¯ãªãœï¼Ÿ"]
        ];
        const selectedQuestion = getRandomFromArray(drillQuestions[session.deepDrillCount - 1], 1)[0];
        
        return res.json({
          response: selectedQuestion,
          step: 1
        });
      } else {
        // å€™è£œæç¤ºï¼ˆ2-3ä»¶å³å®ˆï¼‰
        const candidateOptions = options.slice(0, 3);
        const optionsList = candidateOptions.map((opt, index) => 
          `${index + 1}. ${opt}`
        ).join('\n');
        
        session.awaitingSelection = true;
        session.selectionOptions = candidateOptions;
        
        return res.json({
          response: `ã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿ

${optionsList}

ç•ªå·ã§ã‚‚ã€å†…å®¹ã§ã‚‚ã€ã©ã¡ã‚‰ã§ã‚‚OKã ã‚ˆï¼`,
          step: 1
        });
      }
    }

    // Step2: çµ¶å¯¾å¸Œæœ›ï¼ˆMustæ¡ä»¶ï¼‰
    if (currentStep === 2) {
      // ã€Œãªã„ã€ãƒã‚§ãƒƒã‚¯
      if (message.toLowerCase().includes('ãªã„') || message.toLowerCase().includes('ãªã—')) {
        return res.json({
          response: `ã‚ã‚ŠãŒã¨ã†ï¼

ãã‚Œã˜ã‚ƒã‚æ¬¡ã«ã€ã“ã†ã ã£ãŸã‚‰ã„ã„ãªã€ã¨ã„ã†ã®ã‚’èã„ã¦ã„ãã­ã€‚
ã“ã‚Œã‚‚ä»•äº‹å†…å®¹ã§ã‚‚ã€åˆ¶åº¦ã§ã‚‚ã€æ¡ä»¶é¢ã§ã‚‚ã€æ¡ä»¶ã§ã‚‚OKâ—

ä¾‹ãˆã°ãƒ»ãƒ»ãƒ»
ã€Œãƒã‚¤ã‚«ãƒ¼é€šå‹¤ãŒã§ãã‚‹ã¨å¬‰ã—ã„ãªã€
ã€Œã§ãã‚Œã°å¤œå‹¤ãŒãªã„ã¨ã„ã„ãªã€
ã£ã¦æ„Ÿã˜ï¼`,
          step: 3
        });
      }

      // é¸æŠå‡¦ç†ä¸­ã®å›ç­”ãƒã‚§ãƒƒã‚¯
      if (session.awaitingSelection) {
        const selectedOption = session.selectionOptions.find(opt => 
          message.toLowerCase().includes(opt.toLowerCase()) ||
          message.includes('1') && session.selectionOptions[0] === opt ||
          message.includes('2') && session.selectionOptions[1] === opt ||
          message.includes('3') && session.selectionOptions[2] === opt
        );
        
        if (selectedOption) {
          session.mustConditions.push(selectedOption);
          session.awaitingSelection = false;
          session.selectionOptions = [];
          
          return res.json({
            response: `ãã£ã‹ã€ã€${selectedOption}ã€ãŒçµ¶å¯¾ã£ã¦ã“ã¨ã ã­ï¼

ä»–ã«ã‚‚çµ¶å¯¾æ¡ä»¶ã¯ã‚ã‚‹ï¼Ÿ`,
            step: 2,
            taggedData: {
              mustConditions: session.mustConditions
            }
          });
        }
      }

      // mustWantè¾æ›¸ãƒãƒƒãƒãƒ³ã‚°ï¼ˆå³å¯†ï¼‰
      const matchedItems = mustWantItems.filter(item => {
        const itemLower = item.toLowerCase();
        const messageLower = message.toLowerCase();
        return messageLower.includes(itemLower) || 
               itemLower.includes(messageLower) ||
               // éƒ¨åˆ†ãƒãƒƒãƒãƒ³ã‚°ï¼ˆã‚ˆã‚ŠæŸ”è»Ÿã«ï¼‰
               messageLower.split(' ').some(word => itemLower.includes(word)) ||
               itemLower.split(' ').some(word => messageLower.includes(word));
      });

      if (matchedItems.length === 0) {
        // æœªãƒãƒƒãƒå‡¦ç†
        return res.json({
          response: `ãã£ã‹ã€ã‚ã‹ã£ãŸï¼å¤§äº‹ãªå¸Œæœ›ã ã­â—

ä»–ã«ã‚‚çµ¶å¯¾æ¡ä»¶ã¯ã‚ã‚‹ï¼Ÿ`,
          step: 2
        });
      }

      const topMatches = matchedItems.slice(0, 3);
      if (topMatches.length === 1) {
        session.mustConditions.push(topMatches[0]);
        return res.json({
          response: `ãã£ã‹ã€ã€${topMatches[0]}ã€ãŒçµ¶å¯¾ã£ã¦ã“ã¨ã ã­ï¼

ä»–ã«ã‚‚çµ¶å¯¾æ¡ä»¶ã¯ã‚ã‚‹ï¼Ÿ`,
          step: 2,
          taggedData: {
            mustConditions: session.mustConditions
          }
        });
      } else {
        const optionsList = topMatches.map((opt, index) => 
          `${index + 1}. ${opt}`
        ).join('\n');
        
        session.awaitingSelection = true;
        session.selectionOptions = topMatches;
        
        return res.json({
          response: `ã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿ

${optionsList}

ç•ªå·ã§ã‚‚ã€å†…å®¹ã§ã‚‚ã€ã©ã¡ã‚‰ã§ã‚‚OKã§ã™ï¼`,
          step: 2
        });
      }
    }

    // Step3: å¸Œæœ›æ¡ä»¶ï¼ˆWantæ¡ä»¶ï¼‰
    if (currentStep === 3) {
      // ã€Œãªã„ã€ãƒã‚§ãƒƒã‚¯
      if (message.toLowerCase().includes('ãªã„') || message.toLowerCase().includes('ãªã—')) {
        return res.json({
          response: `è³ªå•ã¯æ®‹ã‚Š2ã¤ï¼
ã‚ã¨å°‘ã—ã ã‹ã‚‰ã€é ‘å¼µã£ã¦ğŸ˜†âœ¨ï¸

æ¬¡ã«æ•™ãˆã¦æ¬²ã—ã„ã®ã¯ã€ã“ã‚Œã¾ã§ã‚„ã£ã¦ããŸã“ã¨ã€
ã“ã“ã¯æ¬¡å›æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã—ã£ã‹ã‚Šãƒ’ã‚¢ãƒªãƒ³ã‚°ã—ã¦ã„ãã‹ã‚‰ã€ã–ã£ãã‚Šã§OKã ã‚ˆã€‚
ã“ã‚Œã¾ã§ã‚„ã£ã¦ããŸã“ã¨ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚æ´»ã‹ã—ãŸã„ã“ã¨ã‚’æ•™ãˆã¦ã­ã€‚`,
          step: 4
        });
      }

      // é¸æŠå‡¦ç†ä¸­ã®å›ç­”ãƒã‚§ãƒƒã‚¯
      if (session.awaitingSelection) {
        const selectedOption = session.selectionOptions.find(opt => 
          message.toLowerCase().includes(opt.toLowerCase()) ||
          message.includes('1') && session.selectionOptions[0] === opt ||
          message.includes('2') && session.selectionOptions[1] === opt ||
          message.includes('3') && session.selectionOptions[2] === opt
        );
        
        if (selectedOption) {
          session.wantConditions.push(selectedOption);
          session.awaitingSelection = false;
          session.selectionOptions = [];
          
          return res.json({
            response: `äº†è§£ï¼ã€${selectedOption}ã€ã ã¨å¬‰ã—ã„ã£ã¦ã“ã¨ã ã­ï¼

ä»–ã«ã‚‚ã‚ã£ãŸã‚‰ã„ã„ãªã£ã¦ã„ã†ã®ã¯ã‚ã‚‹ï¼Ÿ`,
            step: 3,
            taggedData: {
              wantConditions: session.wantConditions
            }
          });
        }
      }

      // mustWantè¾æ›¸ãƒãƒƒãƒãƒ³ã‚°ï¼ˆStep2ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
      const matchedItems = mustWantItems.filter(item => {
        const itemLower = item.toLowerCase();
        const messageLower = message.toLowerCase();
        return messageLower.includes(itemLower) || 
               itemLower.includes(messageLower) ||
               // éƒ¨åˆ†ãƒãƒƒãƒãƒ³ã‚°ï¼ˆã‚ˆã‚ŠæŸ”è»Ÿã«ï¼‰
               messageLower.split(' ').some(word => itemLower.includes(word)) ||
               itemLower.split(' ').some(word => messageLower.includes(word));
      });

      if (matchedItems.length === 0) {
        // æœªãƒãƒƒãƒå‡¦ç†
        return res.json({
          response: `äº†è§£ï¼æ°—æŒã¡ã¯å—ã‘å–ã£ãŸã‚ˆâ—

ä»–ã«ã‚‚ã‚ã£ãŸã‚‰ã„ã„ãªã£ã¦ã„ã†ã®ã¯ã‚ã‚‹ï¼Ÿ`,
          step: 3
        });
      }

      const topMatches = matchedItems.slice(0, 3);
      if (topMatches.length === 1) {
        session.wantConditions.push(topMatches[0]);
        return res.json({
          response: `äº†è§£ï¼ã€${topMatches[0]}ã€ã ã¨å¬‰ã—ã„ã£ã¦ã“ã¨ã ã­ï¼

ä»–ã«ã‚‚ã‚ã£ãŸã‚‰ã„ã„ãªã£ã¦ã„ã†ã®ã¯ã‚ã‚‹ï¼Ÿ`,
          step: 3,
          taggedData: {
            wantConditions: session.wantConditions
          }
        });
      } else {
        const optionsList = topMatches.map((opt, index) => 
          `${index + 1}. ${opt}`
        ).join('\n');
        
        session.awaitingSelection = true;
        session.selectionOptions = topMatches;
        
        return res.json({
          response: `ã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿ

${optionsList}

ç•ªå·ã§ã‚‚ã€å†…å®¹ã§ã‚‚ã€ã©ã¡ã‚‰ã§ã‚‚OKã§ã™ï¼`,
          step: 3
        });
      }
    }

    // Step4: Canï¼ˆã“ã‚Œã¾ã§ã‚„ã£ã¦ããŸã“ã¨ï¼‰
    if (currentStep === 4) {
      session.canDo = message;
      return res.json({
        response: `ã„ã„ã­ï¼

ã“ã‚ŒãŒæœ€å¾Œã®è³ªå•ğŸ‘
ä»Šå›ã®è»¢è·ã§å¶ãˆãŸã„æŒ‘æˆ¦ã‚„ã€å¤¢ã¯ã‚ã‚‹ï¼Ÿ`,
        step: 5
      });
    }

    // Step5: Willï¼ˆæŒ‘æˆ¦ã—ãŸã„ã“ã¨ï¼‰
    if (currentStep === 5) {
      session.willDo = message;
      return res.json({
        response: `ä»Šæ—¥ã¯ãŸãã•ã‚“è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼
ã“ã“ã¾ã§ã®å†…å®¹ã‚’æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å¼•ãç¶™ãã­ã€‚
æ¬¡å›ã®é¢è«‡ã§ä¸€ç·’ã«è©°ã‚ã¦ã„ã“ã†ï¼

ğŸ“‹ **åé›†ãƒ‡ãƒ¼ã‚¿**
æ±‚è·è€…ç•ªå·: ${session.candidateNumber}
è»¢è·ç†ç”±: ${session.transferReason || session.transferReasonRaw || 'æœªè¨­å®š'}
çµ¶å¯¾æ¡ä»¶: ${session.mustConditions.length > 0 ? session.mustConditions.join(', ') : 'æœªè¨­å®š'}
å¸Œæœ›æ¡ä»¶: ${session.wantConditions.length > 0 ? session.wantConditions.join(', ') : 'æœªè¨­å®š'}
æ´»ã‹ã—ãŸã„çµŒé¨“: ${session.canDo}
æŒ‘æˆ¦ã—ãŸã„ã“ã¨: ${session.willDo}`,
        step: 6,
        sessionData: session
      });
    }

    // Step6: å®Œäº†
    if (currentStep >= 6) {
      return res.json({
        response: "ãƒ’ã‚¢ãƒªãƒ³ã‚°å®Œäº†ã§ã™ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸâœ¨",
        step: 6,
        sessionData: session
      });
    }

    return res.json({ 
      response: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 
      step: currentStep 
    });

  } catch (error) {
    console.error('Error in chat API:', error);
    return res.status(500).json({ 
      message: 'Internal server error',
      error: error.message 
    });
  }
}
