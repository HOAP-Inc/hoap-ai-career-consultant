import OpenAI from 'openai'

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY })

const transferReasonFlow = {
  'çµŒå–¶ãƒ»çµ„ç¹”ã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['ç†å¿µ','æ–¹é‡','ä¾¡å€¤è¦³','çµŒå–¶','é‹å–¶','ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ','æ–¹å‘æ€§','ãƒ“ã‚¸ãƒ§ãƒ³','ãƒŸãƒƒã‚·ãƒ§ãƒ³','è€ƒãˆæ–¹','å§¿å‹¢','çµŒå–¶é™£','ãƒˆãƒƒãƒ—','é¢¨é€šã—','æ„è¦‹','ç™ºè¨€','è©•ä¾¡åˆ¶åº¦','è©•ä¾¡','æ˜‡çµ¦','æ˜‡æ ¼','å…¬å¹³','åŸºæº–','æ•™è‚²ä½“åˆ¶','ç ”ä¿®','ãƒãƒ‹ãƒ¥ã‚¢ãƒ«','OJT','ãƒ•ã‚©ãƒ­ãƒ¼','æ•™è‚²','ã‚µãƒãƒ¼ãƒˆ','çµŒå–¶è€…','åŒ»ç™‚è·','ç¾å ´ç†è§£','å£²ä¸Š','æ•°å­—'],
    internal_options: [
      'MVVãƒ»çµŒå–¶ç†å¿µã«å…±æ„Ÿã§ãã‚‹è·å ´ã§åƒããŸã„',
      'é¢¨é€šã—ãŒã‚ˆãæ„è¦‹ãŒè¨€ã„ã‚„ã™ã„è·å ´ã§åƒããŸã„',
      'è©•ä¾¡åˆ¶åº¦ãŒå°å…¥ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„',
      'æ•™è‚²ä½“åˆ¶ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹è·å ´ã§åƒããŸã„',
      'çµŒå–¶è€…ãŒåŒ»ç™‚è·ã®ã¨ã“ã‚ã§åƒããŸã„',
      'çµŒå–¶è€…ãŒåŒ»ç™‚è·ã§ã¯ãªã„ã¨ã“ã‚ã§åƒããŸã„',
    ],
  },
  'åƒãä»²é–“ã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['äººé–“é–¢ä¿‚','è·å ´ã®é›°å›²æ°—','ä¸Šå¸','å…ˆè¼©','åŒåƒš','ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯','ã„ã˜ã‚','ãƒ‘ãƒ¯ãƒãƒ©','ã‚»ã‚¯ãƒãƒ©','é™°å£','æ´¾é–¥','ãŠå±€','ç†ä¸å°½','ç›¸è«‡ã§ããªã„','å­¤ç«‹','ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³','ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«','å°Šæ•¬','æ†§ã‚Œ','è¦‹ç¿’ã„ãŸã„','ä¾¡å€¤è¦³','æ¸©åº¦æ„Ÿ','ã‚„ã‚‹æ°—','ä¿¡é ¼','å“æ ¼','ä¸€è²«æ€§','ç›®æ¨™','æ‰‹æœ¬','è·ç¨®','é€£æº','åŠ©ã‘åˆã„','å£','åˆ†æ–­','å¤æ ª','æ¨©åŠ›','åœ§','æ”¯é…'],
    internal_options: [
      'äººé–“é–¢ä¿‚ã®ãƒˆãƒ©ãƒ–ãƒ«ãŒå°‘ãªã„è·å ´ã§åƒããŸã„',
      'åŒã˜ä¾¡å€¤è¦³ã‚’æŒã¤ä»²é–“ã¨åƒããŸã„',
      'å°Šæ•¬ã§ãã‚‹ä¸Šå¸ãƒ»çµŒå–¶è€…ã¨åƒããŸã„',
      'ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ãªã‚‹ä¸Šå¸ã‚„å…ˆè¼©ãŒã»ã—ã„',
      'è·ç¨®é–¢ä¿‚ãªãä¸€ä½“æ„ŸãŒã‚ã‚‹ä»²é–“ã¨åƒããŸã„',
      'ãŠå±€ãŒã„ãªã„è·å ´ã§åƒããŸã„',
    ],
  },
  'ä»•äº‹å†…å®¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—','æˆé•·','æŒ‘æˆ¦','ã‚„ã‚ŠãŒã„','æ¥­å‹™å†…å®¹','å°‚é–€æ€§','ç ”ä¿®','æ•™è‚²','ã‚­ãƒ£ãƒªã‚¢','æ˜‡é€²','æ˜‡æ ¼','è³‡æ ¼å–å¾—','çµŒé¨“','å­¦ã¹ã‚‹','æ–°ã—ã„','å¹…ã‚’åºƒã’ã‚‹','å¼·ã¿','æ´»ã‹ã™','è³‡æ ¼','å¾—æ„','æœªçµŒé¨“','åˆ†é‡','æ‚£è€…','åˆ©ç”¨è€…','è²¢çŒ®','å®Ÿæ„Ÿ','æ›¸é¡','ä»¶æ•°','å½¹ç«‹ã¤','ã‚ã‚ŠãŒã¨ã†','è²¬ä»»','å½¹è·','æ©Ÿä¼š','é“ç­‹','ç™»ç”¨'],
    internal_options: [
      'ä»Šã¾ã§ã®çµŒé¨“ã‚„è‡ªåˆ†ã®å¼·ã¿ã‚’æ´»ã‹ã—ãŸã„',
      'æœªçµŒé¨“ã®ä»•äº‹ï¼åˆ†é‡ã«æŒ‘æˆ¦ã—ãŸã„',
      'ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸã„',
      'æ‚£è€…ãƒ»åˆ©ç”¨è€…ã¸ã®è²¢çŒ®å®Ÿæ„Ÿã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ä»•äº‹ã«æºã‚ã‚Œã‚‹',
      'æ˜‡é€²ãƒ»æ˜‡æ ¼ã®æ©Ÿä¼šãŒã‚ã‚‹',
    ],
  },
  'åŠ´åƒæ¡ä»¶ã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['æ®‹æ¥­','å¤œå‹¤','ä¼‘æ—¥','æœ‰çµ¦','åƒãæ–¹','æ™‚é–“','ã‚·ãƒ•ãƒˆ','å‹¤å‹™æ™‚é–“','é€£å‹¤','ä¼‘æ†©','ã‚ªãƒ³ã‚³ãƒ¼ãƒ«','å‘¼ã³å‡ºã—','å‰¯æ¥­','å…¼æ¥­','ç¤¾ä¼šä¿é™º','ä¿é™º','å¥ä¿','åšç”Ÿå¹´é‡‘','è¨ºç™‚æ™‚é–“','è‡ªå·±ç ”é‘½','å‹‰å¼·','å­¦ç¿’','ç ”ä¿®æ™‚é–“','ç›´è¡Œç›´å¸°','äº‹å‹™æ‰€','ç«‹ã¡å¯„ã‚Š','æœç¤¼','æ—¥å ±','å®šæ™‚','ã‚µãƒ¼ãƒ“ã‚¹æ®‹æ¥­','ç”³è«‹åˆ¶','äººå“¡é…ç½®','å¸Œæœ›æ—¥','åŠä¼‘','æ™‚é–“æœ‰ä¼‘','æ‰¿èª','å°±æ¥­è¦å‰‡','å…¼æ¥­','è¨±å¯','å¥åº·ä¿é™º','é›‡ç”¨ä¿é™º','åŠ´ç½','æ‰‹ç¶šã','å§‹æ¥­å‰','æº–å‚™','æ¸…æƒ','æ‰“åˆ»'],
    internal_options: [],
  },
  'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«é–¢ã™ã‚‹ã“ã¨': {
    keywords: ['å®¶åº­','è‚²å…','å­è‚²ã¦','ä¸¡ç«‹','ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸','å­ã©ã‚‚','å®¶æ—','ä»‹è­·','ä¿è‚²åœ’','é€è¿','å­¦æ ¡è¡Œäº‹','é€šé™¢','ç™ºç†±','ä¸­æŠœã‘','æ™‚çŸ­','ã‚¤ãƒ™ãƒ³ãƒˆ','é£²ã¿ä¼š','BBQ','ç¤¾å“¡æ—…è¡Œ','æ—©æœæ¸…æƒ','å¼·åˆ¶','æ¥­å‹™å¤–','å°±æ¥­å¾Œ','ä¼‘æ—¥','ã‚ªãƒ•','ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ','ä»²è‰¯ã','äº¤æµ','ã”ã¯ã‚“','è¶£å‘³'],
    internal_options: [
      'å®¶åº­ã¨ã®ä¸¡ç«‹ã«ç†è§£ã®ã‚ã‚‹è·å ´ã§åƒããŸã„',
      'å‹¤å‹™æ™‚é–“å¤–ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„è·å ´ã§åƒããŸã„',
      'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§ã‚‚ä»²è‰¯ãã—ã¦ã„ã‚‹è·å ´ã§åƒããŸã„',
    ],
  },
  'è·å ´ç’°å¢ƒãƒ»è¨­å‚™': { keywords: ['è¨­å‚™','ç’°å¢ƒ','æ–½è¨­','å™¨æ¢°','æ©Ÿå™¨','ã‚·ã‚¹ãƒ†ãƒ ','IT','ãƒ‡ã‚¸ã‚¿ãƒ«','å¤ã„','æ–°ã—ã„','æœ€æ–°','è¨­ç½®','å°å…¥','æ•´å‚™'], internal_options: [] },
  'è·å ´ã®å®‰å®šæ€§': { keywords: ['å®‰å®š','å°†æ¥æ€§','çµŒå–¶çŠ¶æ³','å€’ç”£','ãƒªã‚¹ãƒˆãƒ©','ä¸å®‰','ç¶™ç¶š','æŒç¶š','æˆé•·','ç™ºå±•','å°†æ¥','å…ˆè¡Œã'], internal_options: [] },
  'çµ¦ä¸ãƒ»å¾…é‡': { keywords: ['çµ¦æ–™','çµ¦ä¸','å¹´å','æœˆå','æ‰‹å–ã‚Š','è³ä¸','ãƒœãƒ¼ãƒŠã‚¹','æ˜‡çµ¦','æ‰‹å½“','å¾…é‡','ç¦åˆ©åšç”Ÿ','å®‰ã„','ä½ã„','ä¸ŠãŒã‚‰ãªã„','ç”Ÿæ´»ã§ããªã„','ãŠé‡‘'], internal_options: [] },
}

const mustWantItems = [
  'æ€¥æ€§æœŸç—…æ£Ÿ','å›å¾©æœŸç—…æ£Ÿ','æ…¢æ€§æœŸãƒ»ç™‚é¤Šå‹ç—…é™¢','ä¸€èˆ¬ç—…é™¢','åœ°åŸŸåŒ…æ‹¬ã‚±ã‚¢ç—…æ£Ÿ','ç™‚é¤Šç—…æ£Ÿ',
  'ç·©å’Œã‚±ã‚¢ç—…æ£Ÿï¼ˆãƒ›ã‚¹ãƒ”ã‚¹ï¼‰','ã‚¯ãƒªãƒ‹ãƒƒã‚¯','ç²¾ç¥ç§‘ç—…é™¢','è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
  'ç²¾ç¥ç§‘ç‰¹åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³','æ©Ÿèƒ½å¼·åŒ–å‹è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³','è¨ªå•ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
  'è¨ªå•æ „é¤ŠæŒ‡å°','é€šæ‰€ä»‹è­·ï¼ˆãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰','èªçŸ¥ç—‡å¯¾å¿œå‹é€šæ‰€ä»‹è­·ï¼ˆèªçŸ¥ç—‡å°‚é–€ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼‰',
  'åœ°åŸŸå¯†ç€å‹é€šæ‰€ä»‹è­·ï¼ˆå®šå“¡18åä»¥ä¸‹ï¼‰','é€šæ‰€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ã‚¤ã‚±ã‚¢ï¼‰','è¨ªå•ä»‹è­·',
  'å®šæœŸå·¡å›ãƒ»éšæ™‚å¯¾å¿œå‹è¨ªå•ä»‹è­·çœ‹è­·','è¨ªå•å…¥æµ´','å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·','çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½å‹å±…å®…ä»‹è­·',
  'ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ','åœ°åŸŸå¯†ç€å‹ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ï¼ˆå®šå“¡29åä»¥ä¸‹ï¼‰','ä»‹è­·è€äººä¿å¥æ–½è¨­',
  'ä»‹è­·ä»˜ãæœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ','ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼ˆçŸ­æœŸå…¥æ‰€ç”Ÿæ´»ä»‹è­·ï¼‰','ã‚µãƒ¼ãƒ“ã‚¹ä»˜ãé«˜é½¢è€…å‘ã‘ä½å®…ï¼ˆã‚µé«˜ä½ï¼‰',
  'ä½å®…å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ','è»½è²»è€äººãƒ›ãƒ¼ãƒ ï¼ˆã‚±ã‚¢ãƒã‚¦ã‚¹ï¼‰','å¥åº·å‹æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ','ã‚·ãƒ‹ã‚¢å‘ã‘åˆ†è­²ãƒãƒ³ã‚·ãƒ§ãƒ³',
  'æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹','ç”Ÿæ´»ä»‹è­·ï¼ˆéšœå®³è€…ã®æ—¥ä¸­æ´»å‹•ï¼‰','å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹','å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹',
  'çŸ­æœŸå…¥æ‰€ï¼ˆéšœå®³è€…å‘ã‘ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰','æ­¯ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','è¨ªå•æ­¯ç§‘','æ­¯ç§‘å£è…”å¤–ç§‘ï¼ˆç—…é™¢å†…è¨ºç™‚ç§‘ï¼‰',
  'å¤§å­¦ç—…é™¢æ­¯ç§‘ãƒ»æ­¯å­¦éƒ¨é™„å±ç—…é™¢','æ­¯ç§‘æŠ€å·¥æ‰€','é™¢å†…ãƒ©ãƒœ','ä¿è‚²åœ’','å¹¼ç¨šåœ’',
  'ä¼æ¥­ï¼ˆç”£æ¥­ä¿å¥ãƒ»ä¼æ¥­å†…çœ‹è­·ãªã©ï¼‰','4é€±8ä¼‘ä»¥ä¸Š','è‚²å…æ”¯æ´ã‚ã‚Š','å¹´é–“ä¼‘æ—¥120æ—¥ä»¥ä¸Š',
  'é€±1æ—¥ã‹ã‚‰OK','é€±2æ—¥ã‹ã‚‰OK','åœŸæ—¥ç¥ä¼‘ã¿','å®¶åº­éƒ½åˆä¼‘OK','æœˆ1ã‚·ãƒ•ãƒˆæå‡º',
  'æ¯é€±ï½éš”é€±ã‚·ãƒ•ãƒˆæå‡º','æœ‰çµ¦æ¶ˆåŒ–ç‡ã»ã¼100%','é•·æœŸä¼‘æš‡ã‚ã‚Š','é€±ä¼‘2æ—¥','é€±ä¼‘3æ—¥',
  'æ—¥å‹¤ã®ã¿å¯','å¤œå‹¤å°‚å¾“ã‚ã‚Š','2äº¤æ›¿åˆ¶','3äº¤æ›¿åˆ¶','åˆå‰ã®ã¿å‹¤å‹™','åˆå¾Œã®ã¿å‹¤å‹™',
  'æ®‹æ¥­ã»ã¼ãªã—','ã‚ªãƒ³ã‚³ãƒ¼ãƒ«ãªã—ãƒ»å…é™¤å¯','ç·Šæ€¥è¨ªå•ãªã—','æ™‚å·®å‡ºå‹¤å°å…¥','ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ åˆ¶åº¦ã‚ã‚Š',
  'æ®‹æ¥­æœˆ20æ™‚é–“ä»¥å†…','ã‚¹ã‚­ãƒæ™‚é–“å‹¤å‹™','æ™‚çŸ­å‹¤å‹™ç›¸è«‡å¯','é§…è¿‘ï¼ˆ5åˆ†ä»¥å†…ï¼‰','è»Šé€šå‹¤å¯',
  'ãƒã‚¤ã‚¯é€šå‹¤å¯','è‡ªè»¢è»Šé€šå‹¤å¯','é§è»Šå ´å®Œå‚™','ç›´è¡Œç›´å¸°OK','å¹´å300ä¸‡ä»¥ä¸Š','å¹´å350ä¸‡ä»¥ä¸Š',
  'å¹´å400ä¸‡ä»¥ä¸Š','å¹´å450ä¸‡ä»¥ä¸Š','å¹´å500ä¸‡ä»¥ä¸Š','å¹´å550ä¸‡ä»¥ä¸Š','å¹´å600ä¸‡ä»¥ä¸Š',
  'å¹´å650ä¸‡ä»¥ä¸Š','å¹´å700ä¸‡ä»¥ä¸Š','è³ä¸ã‚ã‚Š','é€€è·é‡‘ã‚ã‚Š','å¯®ã‚ã‚Šãƒ»ç¤¾å®…ã‚ã‚Š',
  'è¨—å…æ‰€ãƒ»ä¿è‚²æ”¯æ´ã‚ã‚Š','ç¤¾ä¼šä¿é™ºå®Œå‚™','äº¤é€šè²»æ”¯çµ¦','æ‰¶é¤Šæ§é™¤å†…è€ƒæ…®','å¾©è·æ”¯æ´',
  'ä½å®…æ‰‹å½“','å‰¯æ¥­OK','æ—¥ãƒ»ç¥æ—¥çµ¦ä¸UP','å¼•è¶Šã—æ‰‹å½“','ç·Šæ€¥è¨ªå•æ™‚ã®æ‰‹å½“ãƒ»ä»£ä¼‘ã‚ã‚Š',
  'ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè²¸ä¸ã‚ã‚Š','é›»å‹•ã‚¢ã‚·ã‚¹ãƒˆè‡ªè»¢è»Šãƒ»ãƒã‚¤ã‚¯ãƒ»è»Šè²¸ä¸','ç¤¾å‰²ã‚ã‚Š',
  'ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆç›¸è«‡çª“å£ã‚ã‚Š','ç ”ä¿®åˆ¶åº¦ã‚ã‚Š','è³‡æ ¼å–å¾—æ”¯æ´ã‚ã‚Š','ã‚»ãƒŸãƒŠãƒ¼å‚åŠ è²»è£œåŠ©ã‚ã‚Š',
  'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Œå‚™','å‹•ç”»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š','è©•ä¾¡åˆ¶åº¦ã‚ã‚Š','ãƒ¡ãƒ³ã‚¿ãƒ¼åˆ¶åº¦ã‚ã‚Š','ç‹¬ç«‹ãƒ»é–‹æ¥­æ”¯æ´ã‚ã‚Š',
  'é™¢é•·ãƒ»åˆ†é™¢é•·å€™è£œ','æ‹…å½“åˆ¶'
]

const sessions = new Map()
function getSession(sessionId) {
  if (!sessions.has(sessionId)) {
    sessions.set(sessionId, {
      candidateNumber: '',
      qualification: '',
      workplace: '',
      transferReason: '',
      mustConditions: [],
      ngConditions: [],
      canDo: '',
      willDo: '',
      deepDrillCount: 0,
      currentCategory: null,
      awaitingSelection: false,
      selectionOptions: [],
    })
  }
  return sessions.get(sessionId)
}

function detectCategory(text) {
  const hits = []
  for (const [cat, cfg] of Object.entries(transferReasonFlow)) {
    const score = cfg.keywords.reduce((s, kw) => (text.includes(kw) ? s + 1 : s), 0)
    if (score > 0) hits.push({ cat, score })
  }
  hits.sort((a, b) => b.score - a.score)
  return hits[0]?.cat || null
}

function pickOptions(cat) {
  const opts = transferReasonFlow[cat]?.internal_options || []
  if (!opts.length) return []
  const shuffled = [...opts].sort(() => Math.random() - 0.5)
  return shuffled.slice(0, Math.min(3, opts.length))
}

function matchMustWant(text) {
  const found = []
  for (const item of mustWantItems) {
    if (text.includes(item)) found.push(item)
  }
  return [...new Set(found)]
}

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ message: 'Method not allowed' })

  try {
    const {
      message,
      conversationHistory = [],
      currentStep = 0,
      candidateNumber = '',
      isNumberConfirmed = false,
      sessionId = 'default',
    } = req.body

    const session = getSession(sessionId)

    if (currentStep === 0) {
      if (!isNumberConfirmed) {
        const num = (message.match(/\d+/) || [null])[0]
        if (num) {
          session.candidateNumber = num
          return res.json({
            response: `æ±‚è·è€…ç•ªå·ï¼š${num} ã§ã™ã­ï¼\nä»–ã®æƒ…å ±ã‚‚ãŠèã‹ã›ãã ã•ã„ã€‚\nâ‘¡ä»Šã®è·ç¨®â‘¢ä»Šã©ã“ã§åƒã„ã¦ã‚‹ï¼Ÿ`,
            candidateNumber: num,
            isNumberConfirmed: true,
            step: 0,
          })
        }
        return res.json({
          response: `ã™ã¿ã¾ã›ã‚“ã€æœ€åˆã«æ±‚è·è€…ç•ªå·ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ\nâ‘ æ±‚è·è€…ç•ªå·â‘¡ä»Šã®è·ç¨®â‘¢ä»Šã©ã“ã§åƒã„ã¦ã‚‹ï¼Ÿ\nã®é †ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
          step: 0,
        })
      }
      session.qualification = message
      return res.json({
        response:
          'ã‚ã‚ŠãŒã¨ã†ï¼\n\nã¯ã˜ã‚ã«ã€ä»Šå›ã®è»¢è·ç†ç”±ã‚’æ•™ãˆã¦ã»ã—ã„ãªã€‚ãã£ã‹ã‘ã£ã¦ã©ã‚“ãªã“ã¨ã ã£ãŸï¼Ÿ\nã—ã‚“ã©ã„ã¨æ€ã£ãŸã“ã¨ã€ã“ã‚Œã¯ã‚‚ã†ç„¡ç†ã£ã¦æ€ã£ãŸã“ã¨ã€é€†ã«ã“ã†ã„ã†ã“ã¨ã«æŒ‘æˆ¦ã—ãŸã„ï¼ã£ã¦æ€ã£ãŸã“ã¨ã€ä½•ã§ã‚‚OKã ã‚ˆâ—',
        step: 1,
      })
    }

    const systemPrompt =
      'ã‚ãªãŸã¯HOAPã®AIã‚­ãƒ£ãƒªã‚¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚ä¼šè©±ã‹ã‚‰è¦ç‚¹ã‚’ã¨ã‚‰ãˆã€ç™»éŒ²æ¸ˆã¿ã®æ­£å¼ãƒ©ãƒ™ãƒ«ã«ã ã‘æ•´åˆã•ã›ã‚‹ã€‚\nç¦æ­¢: å­˜åœ¨ã—ãªã„ã‚¿ã‚°ã®ç”Ÿæˆã€‚\næ³¨æ„: çµ¦ä¸ãƒ»å¾…é‡ï¼è·å ´ç’°å¢ƒãƒ»è¨­å‚™ï¼è·å ´ã®å®‰å®šæ€§ ã¯å€™è£œæç¤ºç¦æ­¢ã€‚å¿…ãš ãªã‚‹ã»ã©ã€ãã®æ°—æŒã¡ã‚ˆãã‚ã‹ã‚‹ï¼å¤§äº‹ãªè»¢è·ã®ãã£ã‹ã‘ã ã­â— ã§å—ã‘æ­¢ã‚ã‚‹ã€‚\nå€™è£œæç¤ºã¯å¸¸ã«2ã€œ3ä»¶ã¾ã§ã€‚'

    if (currentStep === 1) {
      if (session.awaitingSelection) {
        const num = (message.match(/[1-3ï¼‘-ï¼“]/) || [null])[0]
        let chosen = null
        if (num) {
          const idx = parseInt(num.replace('ï¼‘', '1').replace('ï¼’', '2').replace('ï¼“', '3')) - 1
          chosen = session.selectionOptions[idx]
        } else {
          chosen = session.selectionOptions.find((o) => message.includes(o)) || null
        }
        if (chosen) {
          session.transferReason = chosen
          session.awaitingSelection = false
          session.selectionOptions = []
          session.deepDrillCount = 0
          return res.json({
            response: 'äº†è§£ã€‚\nã˜ã‚ƒã‚æ¬¡ã®è³ªå•ï¼çµ¶å¯¾ã«ã‚†ãšã‚Œãªã„æ¡ä»¶ã‚’æ•™ãˆã¦ã»ã—ã„ãªã€‚\næ€ã„ã¤ãç¯„å›²ã§OKã ã‚ˆã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã ã‘ã§ã‚‚å¤§ä¸ˆå¤«ã€‚',
            step: 2,
          })
        }
        const list = session.selectionOptions.map((o, i) => `${i + 1}. ${o}`).join('\n')
        return res.json({ response: `ã†ã¾ãèª­ã¿å–ã‚Œãªã‹ã£ãŸâ€¦\nä»¥ä¸‹ã‹ã‚‰ç•ªå·ã§é¸ã‚“ã§ã­ã€‚\n\n${list}`, step: 1 })
      }

      const cat = detectCategory(message) || session.currentCategory
      if (!session.currentCategory && cat) session.currentCategory = cat

      const noCandidate = !transferReasonFlow[session.currentCategory || '']?.internal_options?.length

      if (session.deepDrillCount < 3 && !noCandidate) {
        session.deepDrillCount += 1
        const followups = {
          'åƒãä»²é–“ã«é–¢ã™ã‚‹ã“ã¨': [
            'ãã‚Œã£ã¦èª°ã¨ã®é–¢ä¿‚ï¼Ÿä¸Šå¸ï¼ŸåŒåƒšï¼Ÿ',
            'ã„ã¤é ƒã‹ã‚‰æ„Ÿã˜ã¦ãŸï¼Ÿãã£ã‹ã‘ã¯ã‚ã£ãŸï¼Ÿ',
            'ãã®çŠ¶æ³ã§ä¸€ç•ªã¤ã‚‰ã‹ã£ãŸãƒã‚¤ãƒ³ãƒˆã¯ã©ã“ï¼Ÿ',
          ],
          'çµŒå–¶ãƒ»çµ„ç¹”ã«é–¢ã™ã‚‹ã“ã¨': [
            'ã©ã®ç‚¹ã®åˆã‚ãªã•ãŒä¸€ç•ªå¤§ãã„ï¼Ÿç†å¿µï¼Ÿé‹ç”¨ï¼Ÿè©•ä¾¡ï¼Ÿ',
            'ç¾å ´ã¸ã®ç†è§£ä¸è¶³ã£ã¦ã©ã®å ´é¢ã§æ„Ÿã˜ãŸï¼Ÿ',
            'æ”¹å–„ã®å£°ã¯å‡ºã—ã‚„ã™ã„é›°å›²æ°—ã ã£ãŸï¼Ÿ',
          ],
          'ä»•äº‹å†…å®¹ãƒ»ã‚­ãƒ£ãƒªã‚¢ã«é–¢ã™ã‚‹ã“ã¨': [
            'ä»Šã®æ¥­å‹™ã§ç‰©è¶³ã‚Šãªã„ã¨ã“ã‚ã¯ã©ã“ï¼Ÿ',
            'æ´»ã‹ã—ãŸã„å¼·ã¿ã£ã¦ä½•ãŒæ€ã„æµ®ã‹ã¶ï¼Ÿ',
            'æŒ‘æˆ¦ã—ãŸã„åˆ†é‡ãŒã‚ã‚Œã°æ•™ãˆã¦ã€‚',
          ],
          'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«é–¢ã™ã‚‹ã“ã¨': [
            'ä¸¡ç«‹ã§ä¸€ç•ªå›°ã£ã¦ã„ã‚‹ã®ã¯ã©ã®æ™‚é–“å¸¯ï¼Ÿ',
            'å‘¨å›²ã®ç†è§£ã¯ã©ã®ç¨‹åº¦ã‚ã‚Šãã†ï¼Ÿ',
            'ã©ã‚“ãªåƒãæ–¹ãªã‚‰å®‰å¿ƒã§ããã†ï¼Ÿ',
          ],
        }
        const follow =
          (followups[session.currentCategory] || ['ã‚‚ã†å°‘ã—ã ã‘è©³ã—ãæ•™ãˆã¦ã€‚ã©ã®ç‚¹ãŒå¼•ã£ã‹ã‹ã£ã¦ã‚‹ï¼Ÿ'])[
            session.deepDrillCount - 1
          ] || 'ã‚‚ã†å°‘ã—ã ã‘æ•™ãˆã¦ã‚‚ã‚‰ã£ã¦ã„ã„ï¼Ÿ'

        return res.json({
          response: `ãªã‚‹ã»ã©ã€ãã®æ°—æŒã¡ã‚ˆãã‚ã‹ã‚‹ï¼å¤§äº‹ãªè»¢è·ã®ãã£ã‹ã‘ã ã­â—\n${follow}`,
          step: 1,
        })
      }

      if (noCandidate) {
        session.transferReason = message.trim()
        session.deepDrillCount = 0
        return res.json({
          response: 'ãªã‚‹ã»ã©ã€ãã®æ°—æŒã¡ã‚ˆãã‚ã‹ã‚‹ï¼å¤§äº‹ãªè»¢è·ã®ãã£ã‹ã‘ã ã­â—\nã˜ã‚ƒã‚æ¬¡ã®è³ªå•ï¼çµ¶å¯¾ã«ã‚†ãšã‚Œãªã„æ¡ä»¶ã‚’æ•™ãˆã¦ã»ã—ã„ãªã€‚',
          step: 2,
        })
      }

      const options = pickOptions(session.currentCategory)
      if (options.length) {
        session.selectionOptions = options
        session.awaitingSelection = true
        const list = options.map((o, i) => `${i + 1}. ${o}`).join('\n')
        return res.json({
          response: `ã“ã“ã¾ã§ã®è©±ã‹ã‚‰è¿‘ã„ã®ã¯ã“ã®ã‚ãŸã‚Šã€‚\nã“ã®ä¸­ã ã¨ã©ã‚ŒãŒä¸€ç•ªè¿‘ã„ï¼Ÿç•ªå·ã§é¸ã‚“ã§ã­ã€‚\n\n${list}`,
          step: 1,
        })
      }

      session.transferReason = message.trim()
      return res.json({
        response: 'OKã€‚ã˜ã‚ƒã‚æ¬¡ã®è³ªå•ï¼çµ¶å¯¾ã«ã‚†ãšã‚Œãªã„æ¡ä»¶ã‚’æ•™ãˆã¦ã»ã—ã„ãªã€‚',
        step: 2,
      })
    }

    if (currentStep === 2) {
      const found = matchMustWant(message)
      if (found.length) {
        session.mustConditions = Array.from(new Set([...(session.mustConditions || []), ...found]))
      }
      return res.json({
        response: 'äº†è§£ã€‚ã§ã¯æ¬¡ã€‚çµ¶å¯¾NGã‚’æ•™ãˆã¦ã€‚\né¿ã‘ãŸã„è·å ´ã‚¿ã‚¤ãƒ—ã‚„åƒãæ–¹ãŒã‚ã‚Œã°æŒ™ã’ã¦ã­ã€‚',
        step: 3,
      })
    }

    if (currentStep === 3) {
      const found = matchMustWant(message)
      if (found.length) {
        session.ngConditions = Array.from(new Set([...(session.ngConditions || []), ...found]))
      }
      return res.json({
        response: 'è³ªå•ã¯æ®‹ã‚Š2ã¤ï¼ã“ã‚Œã¾ã§ã‚„ã£ã¦ããŸã“ã¨ã‚’ã€ã§ãã‚‹ã ã‘è‡ªç„¶ãªè¨€ã„æ–¹ã§æ•™ãˆã¦ã€‚\nç®‡æ¡æ›¸ãã§ã‚‚OKã€‚',
        step: 4,
      })
    }

    if (currentStep === 4) {
      session.canDo = message.trim()
      return res.json({
        response: 'ã“ã‚ŒãŒæœ€å¾Œã®è³ªå•ğŸ‘ ã“ã‚Œã‹ã‚‰æŒ‘æˆ¦ã—ãŸã„ã“ã¨ãƒ»ã‚„ã£ã¦ã¿ãŸã„ã“ã¨ã‚’æ•™ãˆã¦ã€‚\næ°—æŒã¡ãƒ™ãƒ¼ã‚¹ã§ã‚‚OKã ã‚ˆã€‚',
        step: 5,
      })
    }

    if (currentStep === 5) {
      session.willDo = message.trim()

      const summaryPrompt = `${systemPrompt}\næ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ã€é¢è«‡å‰ã®å…±æœ‰ç”¨ã«çŸ­ã„è¦ç´„ã‚’ä½œæˆã€‚\nç¦æ­¢: æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚„é …ç›®ã®ç”Ÿæˆã€‚ä¸ãˆã‚‰ã‚Œã¦ã„ãªã„äº‹å®Ÿã®è¿½åŠ ã€‚\n\nãƒ‡ãƒ¼ã‚¿:\n- è»¢è·ç†ç”±: ${session.transferReason || 'è¨˜éŒ²ãªã—'}\n- çµ¶å¯¾æ¡ä»¶: ${(session.mustConditions || []).join('ã€') || 'ãªã—'}\n- çµ¶å¯¾NG: ${(session.ngConditions || []).join('ã€') || 'ãªã—'}\n- ã“ã‚Œã¾ã§: ${session.canDo || 'æœªå…¥åŠ›'}\n- ã“ã‚Œã‹ã‚‰: ${session.willDo || 'æœªå…¥åŠ›'}\n\nå‡ºåŠ›ã¯æ¬¡ã®é †ç•ªã§è‡ªç„¶æ–‡ã§2ã€œ4è¡Œã€‚\n1. è»¢è·ç†ç”±ã®è¦ç‚¹ã‚’ä¸€è¡Œ\n2. çµ¶å¯¾æ¡ä»¶ã¨çµ¶å¯¾NGã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ\n3. ã“ã‚Œã¾ã§â†’ã“ã‚Œã‹ã‚‰ã®æµã‚ŒãŒä¼ã‚ã‚‹ä¸€è¡Œ`

      let summary = ''
      try {
        const completion = await openai.chat.completions.create({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: summaryPrompt },
          ],
          temperature: 0.2,
          max_tokens: 300,
        })
        summary = completion.choices[0]?.message?.content?.trim() || ''
      } catch (_) {
        summary = 'é¢è«‡å‰å…±æœ‰: è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜æ¸ˆã¿ã§ã™ã€‚'
      }

      const closing =
        `ä»Šæ—¥ã¯ãŸãã•ã‚“è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼\nã“ã®å†…å®¹ã‚’ã‚‚ã¨ã«ã€æ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ”ãƒƒã‚¿ãƒªãªææ¡ˆã‚’æº–å‚™ã™ã‚‹ã­ã€‚\n\nâ–¼é¢è«‡å‰å…±æœ‰\n${summary}`

      return res.json({ response: closing, step: 6, sessionData: session })
    }

    return res.json({ response: 'æƒ³å®šå¤–ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚', step: 0 })
  } catch (error) {
    console.error('Error in chat API:', error)
    return res.status(500).json({ message: 'Internal server error', error: error.message })
  }
}
